<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desafíos Mentales - Edición Estratégica Avanzada</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        /* Estilos Generales (la mayoría se mantienen, solo añadiré o modificaré lo necesario) */
        body {
            font-family: 'Nunito', ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            line-height: 1.6;
            color: #4A5568;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
            overflow-x: hidden;
        }
        .container {
            background-color: rgba(255, 255, 255, 0.97);
            padding: 25px 35px;
            border-radius: 20px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2), 0 8px 15px rgba(0,0,0,0.18);
            text-align: center;
            max-width: 750px;
            width: 100%;
            box-sizing: border-box;
            transition: transform 0.3s ease-out;
            min-height: 680px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        .container:hover {
            transform: translateY(-6px);
        }

        button {
            color: white; padding: 12px 28px; border: none; border-radius: 10px; cursor: pointer; font-size: 1.1em;
            transition: background-color 0.2s ease, transform 0.15s ease, box-shadow 0.2s ease;
            text-transform: uppercase; letter-spacing: 0.8px; box-shadow: 0 5px 8px rgba(0,0,0,0.12);
            margin: 10px; font-family: 'Fredoka One', cursive; font-weight: 400;
        }
        button:hover { transform: translateY(-3px) scale(1.03); box-shadow: 0 7px 12px rgba(0,0,0,0.18); }
        button:active { transform: translateY(-1px) scale(0.98); box-shadow: 0 3px 6px rgba(0,0,0,0.1); }
        button:disabled { background-color: #A0AEC0 !important; cursor: not-allowed; transform: none; box-shadow: 0 5px 8px rgba(0,0,0,0.08);}


        .welcome-screen { display: flex; flex-direction: column; align-items: center; animation: fadeIn 0.5s ease-out; }
        .welcome-screen h1 { color: #5A67D8; margin-bottom: 15px; font-size: 2.6em; text-shadow: 1px 1px 3px rgba(0,0,0,0.1); font-family: 'Fredoka One', cursive; }
        .welcome-screen p { font-size: 1.15em; margin-bottom: 12px; color: #5f6c80; }
        .welcome-screen input[type="text"], .welcome-screen input[type="password"] {
            padding: 14px 18px; margin-bottom: 18px; border: 2px solid #CBD5E0; border-radius: 10px;
            font-size: 1.2em; width: 90%; max-width: 320px; text-align: center; box-sizing: border-box;
            transition: border-color 0.3s ease, box-shadow 0.3s ease; font-family: 'Nunito', sans-serif;
        }
        .welcome-screen input[type="text"]:focus, .welcome-screen input[type="password"]:focus {
            border-color: #5A67D8; box-shadow: 0 0 0 4px rgba(90, 103, 216, 0.25); outline: none;
        }
        .welcome-screen button { background-color: #48BB78; margin-top: 10px; }
        .welcome-screen button:hover { background-color: #3f9e6a; }
        .auth-error-message { color: #E53E3E; font-size: 0.95em; margin-top: -10px; margin-bottom: 10px; display: none; font-weight: 600; }

        .selection-screen { display: none; flex-direction: column; align-items: center; width: 100%; animation: slideInUp 0.6s ease-out; }
        .selection-screen h2 { color: #3a4b60; margin-bottom: 10px; font-size: 2.2em; font-family: 'Fredoka One', cursive; }
        .selection-screen .greeting-subtext { font-size: 1.1em; color: #6b7a90; margin-bottom: 15px; }
        .selection-screen .logout-button { background-color: #A0AEC0; font-size: 0.8em; padding: 8px 15px; margin-top: 0; margin-bottom: 15px; }
        .selection-screen .logout-button:hover { background-color: #7f8c9b; }
        .selection-screen .game-selection-buttons { margin-bottom: 25px; display: flex; flex-wrap: wrap; justify-content: center;}
        .selection-screen .game-selection-buttons button { background-color: #4299E1; min-width: 220px; margin: 8px;}
        .selection-screen .game-selection-buttons button:hover { background-color: #3582c0; }
        /* .selection-screen .game-selection-buttons button:nth-of-type(2) { background-color: #ED8936; } Acertijos Visuales - Eliminado */
        /* .selection-screen .game-selection-buttons button:nth-of-type(2):hover { background-color: #d57b2f; } */
        .selection-screen .game-selection-buttons button:nth-of-type(2) { background-color: #38A169; } /* Simon (ahora es el segundo) */
        .selection-screen .game-selection-buttons button:nth-of-type(2):hover { background-color: #2f855a; }
        .selection-screen .game-selection-buttons button.upcoming { background-color: #718096; }
        .selection-screen .game-selection-buttons button.upcoming:hover { background-color: #5a6470; }


        .selection-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; width: 100%; max-width: 680px; margin-top: 20px; }
        .selection-card { background-color: #f7faff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); text-align: left; transition: transform 0.2s ease-out, box-shadow 0.2s ease-out; }
        .selection-card:hover { transform: translateY(-4px); box-shadow: 0 6px 16px rgba(0,0,0,0.12); }
        .selection-card h3 { font-family: 'Fredoka One', cursive; color: #4a5a94; font-size: 1.4em; margin-bottom: 12px; border-bottom: 2px solid #e2e8f0; padding-bottom: 8px; text-align: center; }
        .selection-card p, .selection-card li { font-size: 1em; color: #5a677a; margin-bottom: 6px; }
        .selection-card strong { color: #3d4a78; font-weight: 700; }
        .selection-card ul { list-style: none; padding: 0; }
        .selection-card .leaderboard-list, .selection-card .medals-list-container { margin-top: 10px; }

        #math-game-container, #simon-game-container { display: none; flex-direction: column; align-items: center; width: 100%; animation: zoomIn 0.4s ease-out; }
        .game-stats { display: flex; justify-content: space-around; align-items: center; width: 100%; margin-bottom: 18px; font-size: 1.05em; color: #718096; padding: 8px 12px; background-color: #f8f9fa; border-radius:10px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); }
        .player-name-display { font-weight: 700; color: #5A67D8; font-size:1.1em; }
        .lives-display, .timer-display { font-weight: 700; font-size:1.1em; color: #4A5568;}
        .lives-display span, .timer-display span { color: #DD6B20; }
        .timer-display.text-red-500 span { color: #E53E3E !important; animation: pulseRed 1s infinite; }

        #math-game-container .level-info { font-size: 1.15em; color: #4A5568; margin-bottom: 6px; font-weight: 600; }
        #math-game-container .progress-bar-container { width: 85%; max-width: 420px; height: 24px; background-color: #E2E8F0; border-radius: 12px; margin-bottom: 18px; overflow: hidden; border: 1px solid #CBD5E0; box-shadow: inset 0 1px 2px rgba(0,0,0,0.05); }
        #math-game-container .progress-bar { height: 100%; width: 0%; background: linear-gradient(to right, #68D391, #48BB78); border-radius: 11px; transition: width 0.5s ease-in-out; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.9em; font-weight: 600; text-shadow: 1px 1px 1px rgba(0,0,0,0.2); }
        #math-game-container .problem { font-size: 2.3em; margin-bottom: 22px; color: #2D3748; min-height: 1.6em; display: flex; justify-content: center; align-items: center; flex-wrap: wrap; padding: 12px 18px; background-color: #edf2f7; border-radius: 10px; box-shadow: inset 0 2px 5px rgba(0,0,0,0.07); font-family: 'Fredoka One', cursive; }
        #math-game-container .problem span { margin: 0 10px; }
        #math-game-container .input-area { margin-bottom: 22px; display: flex; justify-content: center; align-items: center; flex-wrap: wrap; }
        #math-game-container input[type="number"] { padding: 14px 18px; margin: 6px; border: 2px solid #CBD5E0; border-radius: 10px; font-size: 1.45em; width: 140px; text-align: center; box-sizing: border-box; transition: border-color 0.3s ease, box-shadow 0.3s ease; font-family: 'Nunito', sans-serif; }
        #math-game-container input[type="number"]:focus { border-color: #63B3ED; box-shadow: 0 0 0 4px rgba(99, 179, 237, 0.25); outline: none; }
        #math-game-container .input-area button { background-color: #4299E1; margin-left: 12px; }
        #math-game-container .input-area button:hover { background-color: #3582c0; }
        #math-game-container .result-area { margin-top: 18px; width: 100%; }
        #math-game-container .result { font-size: 1.25em; font-weight: 700; min-height: 1.6em; transition: transform 0.3s ease-out, background-color 0.3s ease, color 0.3s ease; padding: 12px 18px; border-radius: 10px; margin-bottom:12px; }
        #math-game-container .result.correct { color: #2F855A; background-color: #C6F6D5; transform: scale(1.03); border: 1px solid #9AE6B4;}
        #math-game-container .result.incorrect { color: #C53030; background-color: #FED7D7; animation: shake 0.5s; border: 1px solid #FEB2B2;}
        #math-game-container .result.level-up { color: #B7791F; background-color: #FEEBC8; transform: scale(1.08); animation: pulse 1s 1; border: 1px solid #FBD38D;}
        #math-game-container .result.level-down { color: #C53030; background-color: #FED7D7; animation: shake 0.8s; border: 1px solid #FEB2B2;}
        #math-game-container .explanation { font-size: 0.95em; color: #4A5568; margin-top: 8px; padding: 12px; background-color: #f7fafc; border: 1px solid #e2e8f0; border-radius: 10px; text-align: left; line-height: 1.55; max-height: 110px; overflow-y: auto; }
        #math-game-container .explanation strong { color: #2D3748; }
        #math-game-container .explanation code { background-color: #edf2f7; padding: 3px 6px; border-radius: 5px; font-family: monospace; color: #2b6cb0;}
        .back-to-selection-btn { background-color: #A0AEC0; margin-top: 25px; font-size: 1em; padding: 10px 18px; }
        .back-to-selection-btn:hover { background-color: #7f8c9b; }

        /* ESTILOS JUEGO SIMON (SIN CAMBIOS) */
        #simon-game-container h2 { color: #38A169; margin-bottom: 10px; font-size: 2.1em; font-family: 'Fredoka One', cursive;}
        #simon-game-container .cognitive-concept { font-size: 1em; color: #5a677a; margin: 0 auto 15px auto; max-width: 80%; line-height: 1.5; }
        #simon-start-button { background-color: #38A169; margin-bottom: 20px; }
        #simon-start-button:hover { background-color: #2f855a; }
        #simon-pads-area { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; width: 220px; height: 220px; margin: 0 auto 20px auto; }
        .simon-pad { border-radius: 15px; cursor: pointer; transition: opacity 0.1s ease-in-out, transform 0.1s ease-in-out; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .simon-pad:hover:not(.active):not(:disabled) { transform: scale(1.03); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        .simon-pad:active:not(.active):not(:disabled) { transform: scale(0.97); }
        .simon-pad.red { background-color: #e74c3c; } .simon-pad.green { background-color: #2ecc71; }
        .simon-pad.blue { background-color: #3498db; } .simon-pad.yellow { background-color: #f1c40f; }
        .simon-pad.active { opacity: 0.6; transform: scale(0.95); box-shadow: inset 0 0 10px rgba(0,0,0,0.2); }
        .simon-pad:disabled { cursor: not-allowed; opacity: 0.7; }
        #simon-game-container .score-display { font-size: 1.3em; font-weight: 700; color: #4A5568; margin-bottom: 10px; }
        #simon-game-container .score-display strong { color: #38A169; }
        #simon-feedback { font-size: 1.1em; color: #5A67D8; font-weight: 600; min-height: 1.5em; margin-bottom: 15px; }

        /* ESTILOS PARA FIGURAS Y PUZLES DE ACERTIJOS VISUALES (COMENTADOS/ELIMINADOS SI NO SE USAN EN OTRO LADO) */
        /*
        .geom-shape { width: 50px; height: 50px; display: flex; justify-content: center; align-items: center; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease; user-select: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .geom-shape:hover { transform: scale(1.08); border-color: #f1c40f; box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .geom-shape.shape-circle { border-radius: 50%; } .geom-shape.shape-square { border-radius: 0; }
        .geom-shape.shape-triangle { width: 0; height: 0; background-color: transparent !important; border-left: 25px solid transparent; border-right: 25px solid transparent; border-bottom-width: 43.3px; border-bottom-style: solid; box-shadow: none; }
        .geom-shape.color-red { background-color: #e74c3c; } .geom-shape.shape-triangle.color-red { border-bottom-color: #e74c3c; }
        */

        /* Loot Box, Leaderboard, Medals, Daily Bonus, Notifications, Animaciones (Se mantienen como están) */
        .loot-box-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.75); display: flex; justify-content: center; align-items: center; z-index: 100; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .loot-box-container.visible { opacity: 1; visibility: visible; }
        .loot-box-content { background-color: #fff; padding: 35px; border-radius: 18px; text-align: center; box-shadow: 0 12px 28px rgba(0,0,0,0.3); max-width: 420px; width: 90%; transform: scale(0.8) translateY(20px); transition: transform 0.35s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .loot-box-container.visible .loot-box-content { transform: scale(1) translateY(0); }
        .loot-box-content h3 { color: #DD6B20; font-size: 2em; margin-bottom: 18px; font-family: 'Fredoka One', cursive; }
        .loot-box-content .loot-box-icon { font-size: 3.5em; margin-bottom: 22px; animation: bounce 0.8s infinite alternate; }
        .loot-box-content .loot-box-reward { font-size: 1.25em; color: #4A5568; margin-bottom: 25px; font-weight: 600; }
        .loot-box-content button { background-color: #4299E1; }
        .loot-box-content button:hover { background-color: #3582c0; }
        .leaderboard-list { list-style: none; padding: 0; margin: 0; max-height: 160px; overflow-y: auto; border: 1px solid #eaf0f6; border-radius: 8px; background-color: #fff; }
        .leaderboard-item { background-color: transparent; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; font-size: 0.95em; border-bottom: 1px solid #eaf0f6; }
        .leaderboard-item:last-child { border-bottom: none; }
        .leaderboard-item strong { color: #5A67D8; font-weight: 700; }
        .leaderboard-item span { font-weight: 600; color: #4A5568; }
        .leaderboard-item.you { background-color: #e6effc; border-left: 4px solid #667eea; font-weight: bold; }
        .leaderboard-list::-webkit-scrollbar { width: 6px; }
        .leaderboard-list::-webkit-scrollbar-thumb { background-color: #cdd5e0; border-radius: 3px; }
        .medals-list-container { text-align: center; }
        .medals-list { display: flex; justify-content: center; flex-wrap: wrap; gap: 18px; padding-top: 5px; }
        .medal-item { font-size: 2.6em; cursor: help; transition: transform 0.2s ease, filter 0.2s ease; position: relative; }
        .medal-item:hover { transform: scale(1.2); filter: brightness(1.1); }
        .medal-item.locked { filter: grayscale(100%) opacity(0.5); }
        .medal-item.locked:hover { filter: grayscale(80%) opacity(0.7); transform: scale(1.1);}
        .medal-tooltip { visibility: hidden; width: 130px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 8px; position: absolute; z-index: 1; bottom: 130%; left: 50%; margin-left: -65px; opacity: 0; transition: opacity 0.3s, transform 0.3s; font-size: 0.45em; pointer-events: none; transform: translateY(10px); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .medal-tooltip::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -6px; border-width: 6px; border-style: solid; border-color: #333 transparent transparent transparent; }
        .medal-item:hover .medal-tooltip { visibility: visible; opacity: 1; transform: translateY(0); }
        .daily-bonus-card { background-color: #fff9e6; border: 2px dashed #f6e05e; }
        .daily-bonus-card h3 { color: #c09511; }
        .daily-bonus-container { margin-top: 0; padding: 15px; background-color: transparent; border: none; border-radius: 8px; text-align: center; color: #744210; font-weight: 600; display: none; width: 100%; }
        .daily-bonus-container h4 { font-size: 1.25em; margin-bottom: 12px; color: #b7791f; font-family: 'Fredoka One', cursive; }
        .daily-bonus-container p { font-size: 1em; margin-bottom: 10px;}
        .daily-bonus-container button { background-color: #f6ad55; font-size: 1em; padding: 10px 18px; margin-top: 12px; }
        .daily-bonus-container button:hover { background-color: #e99d42; }
        .notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(150%); background-color: #333; color: white; padding: 12px 22px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.25); z-index: 101; opacity: 0; visibility: hidden; transition: opacity 0.4s ease, visibility 0.4s ease, transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); font-size: 1em; font-weight: 600; min-width: 250px; text-align: center; }
        .notification.show { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0); }
        .notification.event { background-color: #805AD5; }
        .notification.streak { background-color: #D53F8C; }
        .notification.medal { background-color: #D69E2E; color: white; }
        .notification.error { background-color: #C53030; }
        .notification.success { background-color: #38A169; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes zoomIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-7px); } 50% { transform: translateX(7px); } 75% { transform: translateX(-7px); } }
        @keyframes pulse { 0% { transform: scale(1.05); box-shadow: 0 0 0 0 rgba(221, 107, 32, 0.6); } 70% { transform: scale(1.12); box-shadow: 0 0 12px 18px rgba(221, 107, 32, 0); } 100% { transform: scale(1.05); box-shadow: 0 0 0 0 rgba(221, 107, 32, 0); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-12px); } }
        @keyframes pulseRed { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        @media (max-width: 700px) {
            .selection-grid { grid-template-columns: 1fr; }
            .container { padding: 20px; min-height: auto; }
            .welcome-screen h1 { font-size: 2.2em; }
            .selection-screen h2 { font-size: 1.9em; }
            button { font-size: 1em; padding: 10px 20px; margin: 8px;}
            .game-stats { flex-direction: column; align-items: center; gap: 6px; }
            .player-name-display, .lives-display, .timer-display { font-size: 1em;}
            #math-game-container .problem { font-size: 1.9em; }
            #math-game-container input[type="number"] { font-size: 1.2em; width: 100px; padding: 10px 12px;}
            #math-game-container .explanation { font-size: 0.85em; max-height: 90px;}
            /* #mind-twist-game-container #mind-twist-puzzle-area { min-height: 220px; max-width: 90vw; padding: 15px;} */
             #simon-pads-area { width: 200px; height: 200px; gap: 10px;}
            /* .odd-one-out-shape { width: 60px; height: 60px; } */
            /* .geom-shape { width: 40px; height: 40px; } */
            /* .geom-shape.shape-triangle { border-left-width: 20px; border-right-width: 20px; border-bottom-width: 34.6px; } */
            /* .missing-pattern-placeholder { width: 50px; height: 50px; font-size: 1.8em; } */
            /* .missing-pattern-options .geom-shape { width: 50px; height: 50px; } */
            /* .missing-pattern-options .geom-shape.shape-triangle { border-left-width: 25px; border-right-width: 25px; border-bottom-width: 43.3px; } */
            /* .symbol-word-puzzle { font-size: 2em; } */
            /* .symbol-word-input-area input[type="text"] { font-size: 1.1em; width: 160px; } */
            .notification { width: calc(100% - 40px); bottom: 15px; left: 20px; transform: translateY(150%) translateX(0); }
            .notification.show { transform: translateY(0) translateX(0); }
        }
         @media (max-width: 480px) {
            body { padding: 10px; }
            .container { padding: 15px 20px; }
            .welcome-screen h1 { font-size: 1.8em; }
            .welcome-screen p { font-size: 1em; }
            .welcome-screen input[type="text"], .welcome-screen input[type="password"] { font-size: 1.1em; }
            .selection-screen h2 { font-size: 1.6em; }
            .selection-card h3 { font-size: 1.2em; }
            button { padding: 10px 15px; font-size: 0.95em;}
            #math-game-container .problem { font-size: 1.6em; }
            #math-game-container .input-area button { margin-left: 8px; }
            #math-game-container .result { font-size: 1.1em; }
            /* #mind-twist-game-container h2, */ #simon-game-container h2 { font-size: 1.7em; }
            /* #mind-twist-game-container #mind-twist-question { font-size: 1.1em;} */
            /* #mind-twist-game-container #mind-twist-puzzle-area { min-height: 200px; gap: 10px; padding:10px; } */
            #simon-pads-area { width: 180px; height: 180px; gap: 8px;}
            .simon-pad { border-radius: 10px; }
            #simon-game-container .score-display { font-size: 1.2em; }
            #simon-feedback { font-size: 1em; }
            /* .odd-one-out-shape { width: 50px; height: 50px; } */
            /* .geom-shape { width: 30px; height: 30px; } */
            /* .geom-shape.shape-triangle { border-left-width: 15px; border-right-width: 15px; border-bottom-width: 26px; } */
            /* .missing-pattern-placeholder { width: 40px; height: 40px; font-size: 1.5em; } */
            /* .missing-pattern-options .geom-shape { width: 40px; height: 40px; } */
            /* .missing-pattern-options .geom-shape.shape-triangle { border-left-width: 20px; border-right-width: 20px; border-bottom-width: 34.6px; } */
            .loot-box-content h3 { font-size: 1.6em; }
            .loot-box-content .loot-box-icon { font-size: 2.5em; }
            .loot-box-content .loot-box-reward { font-size: 1.05em; }
            .medal-item { font-size: 2.2em; }
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="welcome-screen" id="welcome-screen">
            <h1>🚀 ¡Desafíos Mentales! 🧠</h1>
            <p>Ingresa tus datos para la aventura:</p>
            <input type="text" id="player-name-input" placeholder="Tu Nombre de Campeón" maxlength="20">
            <input type="password" id="player-password-input" placeholder="Contraseña (mín. 4)" maxlength="20">
            <p id="auth-error-message" class="auth-error-message">Error aquí</p>
            <button onclick="handleLoginOrCreate()">Acceder / Crear</button>
        </div>

        <div class="selection-screen" id="selection-screen">
            <h2>¡Hola, <span id="display-player-name-selection"></span>!</h2>
            <p class="greeting-subtext">¿Listo para ejercitar tu mente? Elige tu desafío:</p>
            <button class="logout-button" onclick="logout()">Cerrar Sesión</button>
            <div class="game-selection-buttons">
                <button onclick="selectGame('math')">Mates Rápidas 🧮</button>
                <button onclick="selectGame('simon')">Secuencia de Colores 🎨</button>
                <button onclick="selectGame('numberMemory')" class="upcoming">Memoria de Números 🔢 (Próximamente)</button>
                <button onclick="selectGame('memoryPairs')" class="upcoming">Parejas de Memoria 🃏 (Próximamente)</button>
                <button onclick="selectGame('slidingPuzzle')" class="upcoming">Laberinto Deslizante 🧱 (Próximamente)</button>
            </div>
            <div class="selection-grid">
                <div class="selection-card" id="player-stats-card">
                    <h3>📊 Tus Estadísticas</h3>
                    <div class="player-stats-summary">
                        <p>Mejor Racha (Mates): <strong id="summary-math-best-streak">0</strong></p>
                        <!-- <p>Acertijos Resueltos: <strong id="summary-mindtwist-solved">0</strong></p> ELIMINADO -->
                        <p>Puntuación Máx. (Simón): <strong id="summary-simon-score">0</strong></p>
                    </div>
                </div>
                <div class="selection-card" id="leaderboard-card">
                    <h3>🏆 Tabla de Posiciones</h3>
                    <p style="font-size:0.85em; text-align:center; margin-bottom:8px;">(Mejor Racha en Mates / Puntuación Simón)</p>
                    <ul class="leaderboard-list" id="leaderboard-list"></ul>
                </div>
                <div class="selection-card" id="medals-card">
                    <h3>🎖️ Tus Medallas</h3>
                    <div class="medals-list-container">
                        <div class="medals-list" id="medals-list"></div>
                    </div>
                </div>
                 <div class="selection-card daily-bonus-card" id="daily-bonus-card-container" style="display:none;"> <h3>🎁 Bonificación Diaria</h3>
                    <div class="daily-bonus-container" id="daily-bonus-container">
                        <h4>🎉 ¡Recompensa Especial! 🎉</h4>
                        <p id="daily-bonus-message"></p>
                        <button onclick="collectDailyBonus()">¡Reclamar!</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="math-game-container">
            <div class="game-stats">
                <div class="player-name-display">Jugador: <span id="math-display-player-name"></span></div>
                <div class="lives-display">❤️ Vidas: <span id="math-player-lives">3</span></div>
                <div class="timer-display" id="math-timer-wrapper">⏱️ Tiempo: <span id="math-time-left">0</span>s</div>
            </div>
            <div class="level-info">Nivel: <span id="math-current-level">1</span></div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="math-progress-bar-fill">0%</div>
            </div>
            <div class="level-info">Racha Actual: <span id="math-correct-streak">0</span>/<span id="math-correct-per-level-display">5</span></div>
            <div class="level-info">Mejor Racha: <span id="math-best-streak">0</span></div>
            <div class="problem" id="math-problem"></div>
            <div class="input-area">
                <input type="number" id="math-user-answer" placeholder="Tu Respuesta" inputmode="numeric">
                <button onclick="checkMathAnswer()">Verificar ✨</button>
            </div>
            <div class="result-area">
                <div class="result" id="math-game-result"></div>
                <div class="explanation" id="math-answer-explanation" style="display: none;"></div>
            </div>
            <button class="back-to-selection-btn" onclick="showScreen('selection')">↩️ Volver a Elegir Juego</button>
        </div>

        <!-- Contenedor del Juego de Acertijos Visuales ELIMINADO TEMPORALMENTE -->
        <!-- <div id="mind-twist-game-container"> ... </div> -->

        <div id="simon-game-container">
            <h2>Secuencia de Colores</h2>
            <p class="cognitive-concept">Concepto Cognitivo: Memoria de trabajo, atención y control inhibitorio. Este juego desafía tu capacidad para recordar y reproducir secuencias visuales.</p>
            <button id="simon-start-button" onclick="startSimonGame()">Empezar Juego</button>
            <div id="simon-pads-area">
                <div class="simon-pad red" data-color="red" id="simon-pad-red"></div>
                <div class="simon-pad green" data-color="green" id="simon-pad-green"></div>
                <div class="simon-pad blue" data-color="blue" id="simon-pad-blue"></div>
                <div class="simon-pad yellow" data-color="yellow" id="simon-pad-yellow"></div>
            </div>
            <p class="score-display">Puntuación: <strong id="simon-score">0</strong></p>
            <p id="simon-feedback">¡Presiona "Empezar Juego"!</p>
            <button class="back-to-selection-btn" onclick="showScreen('selection')">↩️ Volver a Elegir Juego</button>
        </div>


        <div class="loot-box-container" id="loot-box-modal">
            <div class="loot-box-content">
                <h3>¡Caja de Recompensas!</h3>
                <div class="loot-box-icon">🎁</div>
                <p class="loot-box-reward" id="loot-box-reward-text">Abriendo...</p>
                <button onclick="closeLootBox()">¡Genial!</button>
            </div>
        </div>
        <div class="notification" id="notification-display"></div>
    </div>

    <script>
        // --- DOM Elements ---
        const welcomeScreen = document.getElementById('welcome-screen');
        const selectionScreen = document.getElementById('selection-screen');
        const mathGameContainer = document.getElementById('math-game-container');
        // const mindTwistGameContainer = document.getElementById('mind-twist-game-container'); // ELIMINADO
        const simonGameContainer = document.getElementById('simon-game-container');

        const playerNameInput = document.getElementById('player-name-input');
        const playerPasswordInput = document.getElementById('player-password-input');
        const authErrorMessage = document.getElementById('auth-error-message');
        const displayPlayerNameSelection = document.getElementById('display-player-name-selection');

        const mathDisplayPlayerName = document.getElementById('math-display-player-name');
        const mathPlayerLivesDisplay = document.getElementById('math-player-lives');
        const mathTimeLeftDisplay = document.getElementById('math-time-left');
        const mathTimerWrapper = document.getElementById('math-timer-wrapper');
        const mathCurrentLevelDisplay = document.getElementById('math-current-level');
        const mathProgressBarFill = document.getElementById('math-progress-bar-fill');
        const mathCorrectStreakDisplay = document.getElementById('math-correct-streak');
        const mathCorrectPerLevelDisplay = document.getElementById('math-correct-per-level-display');
        const mathBestStreakDisplay = document.getElementById('math-best-streak');
        const mathProblemDisplay = document.getElementById('math-problem');
        const mathUserAnswerInput = document.getElementById('math-user-answer');
        const mathGameResultDisplay = document.getElementById('math-game-result');
        const mathAnswerExplanationDisplay = document.getElementById('math-answer-explanation');

        // Mind Twist Game Elements (Comentados)
        // const mindtwistDisplayPlayerName = document.getElementById('mindtwist-display-player-name');
        // const mindtwistTimeLeftDisplay = document.getElementById('mindtwist-time-left');
        // const mindtwistTimerWrapper = document.getElementById('mindtwist-timer-wrapper');
        // const mindTwistQuestionDisplay = document.getElementById('mind-twist-question');
        // const mindTwistPuzzleArea = document.getElementById('mind-twist-puzzle-area');
        // const mindTwistFeedbackDisplay = document.getElementById('mind-twist-feedback');
        // const mindTwistNextLevelBtn = document.getElementById('mind-twist-next-level-btn');

        const simonStartButton = document.getElementById('simon-start-button');
        const simonPadsArea = document.getElementById('simon-pads-area');
        const simonPadRed = document.getElementById('simon-pad-red');
        const simonPadGreen = document.getElementById('simon-pad-green');
        const simonPadBlue = document.getElementById('simon-pad-blue');
        const simonPadYellow = document.getElementById('simon-pad-yellow');
        const simonScoreDisplay = document.getElementById('simon-score');
        const simonFeedbackDisplay = document.getElementById('simon-feedback');
        const simonPadElements = {
            red: simonPadRed, green: simonPadGreen,
            blue: simonPadBlue, yellow: simonPadYellow
        };

        const summaryMathBestStreak = document.getElementById('summary-math-best-streak');
        // const summaryMindtwistSolved = document.getElementById('summary-mindtwist-solved'); // ELIMINADO
        const summarySimonScore = document.getElementById('summary-simon-score');

        const lootBoxModal = document.getElementById('loot-box-modal');
        const lootBoxRewardText = document.getElementById('loot-box-reward-text');
        const notificationDisplay = document.getElementById('notification-display');
        const leaderboardList = document.getElementById('leaderboard-list');
        const medalsList = document.getElementById('medals-list');
        const dailyBonusContainer = document.getElementById('daily-bonus-container');
        const dailyBonusCardContainer = document.getElementById('daily-bonus-card-container');
        const dailyBonusMessage = document.getElementById('daily-bonus-message');

        let currentLoggedInPlayer = null;
        let allUsersData = {};
        const defaultPlayerStats = () => ({
            math: { currentLevel: 1, correctStreak: 0, bestStreak: 0, playerLives: 3, totalCorrect: 0, totalIncorrect: 0, totalGamesPlayed: 0, questionsInLevel: 0 },
            // mindtwist: { currentLevel: 0, solvedCount: 0, totalAttempts: 0, highestLevelReached: 0 }, // ELIMINADO
            simon: { highestScore: 0, longestSequence: 0, totalGamesPlayed: 0 },
            inventory: [], medals: [], lastPlayed: null, dailyBonusDay: 0, lastLoginDate: null,
            loginHistory: []
        });

        let activeGame = null;
        const MATH_CORRECT_PER_LEVEL = 5; const MATH_MAX_LEVEL = 20; const INITIAL_LIVES = 3;
        let mathCorrectAnswer; let mathTimerId = null; let mathTimeLeft = 0;
        const MATH_BASE_TIME_PER_QUESTION = 15; const MATH_TIME_REDUCTION_PER_LEVEL = 0.5; const MATH_MIN_TIME_PER_QUESTION = 5;
        // Mind Twist Game Config (Comentado)
        // let mindTwistTimerId = null; let mindTwistTimeLeft = 0;
        // const MIND_TWIST_BASE_TIME = 25; const MIND_TWIST_TIME_INCREMENT_PER_LEVEL = 5;
        let simonGameActive = false;
        let simonSequence = [];
        let simonPlayerSequence = [];
        let simonCurrentScore = 0;
        let simonTurn = 'computer';
        const SIMON_COLORS = ['red', 'green', 'blue', 'yellow'];
        const SIMON_FLASH_DURATION = 300;
        const SIMON_INTER_FLASH_DELAY = 250;
        const SIMON_ROUND_DELAY = 1000;

        const MATH_GAME_LOOT_BOX_PROBABILITY = 0.25; /* const MINDTWIST_LOOT_BOX_PROBABILITY = 0.15; */ const SIMON_LOOT_BOX_PROBABILITY = 0.20;
        const MEDALS = [
            { id: "first_game", name: "Primer Juego", description: "Juega tu primera partida de cualquier juego.", icon: "🎮", condition: (stats) => stats.math.totalGamesPlayed > 0 /* || stats.mindtwist.totalAttempts > 0 */ || stats.simon.totalGamesPlayed > 0},
            { id: "math_first_correct", name: "Matiniciante", description: "Resuelve tu primer problema de Mates Rápidas.", icon: "➕", condition: (stats) => stats.math.totalCorrect > 0 && stats.math.totalGamesPlayed > 0 },
            // { id: "mindtwist_first_try", name: "Explorador de Acertijos", description: "Intenta resolver tu primer acertijo visual.", icon: "👀", condition: (stats) => stats.mindtwist.totalAttempts > 0 }, // ELIMINADO
            { id: "simon_first_game", name: "Maestro Simón Jr.", description: "Juega tu primera partida de Secuencia de Colores.", icon: "🎨", condition: (stats) => stats.simon.totalGamesPlayed > 0},
            { id: "math_streak_5", name: "Racha de 5 (Mates)", description: "Logra una racha de 5 respuestas correctas en Mates Rápidas.", icon: "🏅", condition: (stats) => stats.math.bestStreak >= 5 },
            { id: "math_level_5", name: "Nivel 5 (Mates)", description: "Alcanza el nivel 5 en Mates Rápidas.", icon: "🏆", condition: (stats) => stats.math.currentLevel >= 5 },
            { id: "math_level_10", name: "Nivel 10 (Mates)", description: "Alcanza el nivel 10 en Mates Rápidas.", icon: "🌟", condition: (stats) => stats.math.currentLevel >= 10 },
            // { id: "mindtwist_solved_1", name: "Primer Acertijo Resuelto", description: "Resuelve tu primer acertijo visual.", icon: "💡", condition: (stats) => stats.mindtwist.solvedCount >= 1 }, // ELIMINADO
            // { id: "mindtwist_solved_3", name: "Maestro de Acertijos Jr.", description: "Resuelve 3 acertijos visuales.", icon: "🧠", condition: (stats) => stats.mindtwist.solvedCount >= 3 }, // ELIMINADO
            { id: "simon_score_50", name: "Simón Puntuador", description: "Alcanza 50 puntos en Secuencia de Colores.", icon: "🎯", condition: (stats) => stats.simon.highestScore >= 50},
            { id: "simon_sequence_5", name: "Memoria Prodigiosa", description: "Repite una secuencia de 5 colores en Simón.", icon: "🧠", condition: (stats) => stats.simon.longestSequence >= 5},
            { id: "daily_login_3", name: "Visitante Frecuente", description: "Inicia sesión 3 días diferentes.", icon: "📅", condition: (stats) => countUniqueLoginDays(stats) >= 3 }
        ];

        let mathCurrentProblemDetails = {};
        // Mind Twist Level Variables (Comentadas)
        // let oddOneOut_correctShapeIndex; let oddOneOut_shapes = [];
        // let geometricDiscrepancy_correctIndex; let geometricDiscrepancy_panelsFigures = [];
        // let missingPattern_correctOption;
        // let symbolWord_correctWord;
        // const mindTwistLevels = [ /* ... */ ]; // Comentado

        let synthsInitialized = false;
        let correctSound, incorrectSound, levelUpSound, gameStartSound, levelDownSound, lifeLostSound, /* mindTwistCorrectSound, mindTwistIncorrectSound, */ lootBoxSound, dailyBonusSound, medalSound, clickSound, timerTickSound, simonPadSounds = {};

        async function initializeAudio() { if (synthsInitialized || (Tone.context && Tone.context.state === 'running')) return; try { await Tone.start(); console.log("AudioContext started successfully!"); correctSound = new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.05, release: 0.2 } }).toDestination(); incorrectSound = new Tone.Synth({ oscillator: { type: "square" }, envelope: { attack: 0.02, decay: 0.2, sustain: 0, release: 0.2 }, volume: -10 }).toDestination(); levelUpSound = new Tone.PolySynth(Tone.Synth, { oscillator: { type: "sawtooth" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.3, release: 0.5 }, volume: -5 }).toDestination(); gameStartSound = new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.05, decay: 0.3, sustain: 0.1, release: 0.5 }, volume: -8 }).toDestination(); levelDownSound = new Tone.NoiseSynth({ noise: { type: 'brown' }, envelope: { attack: 0.05, decay: 0.3, sustain: 0.1, release: 0.3 }, volume: -10 }).toDestination(); lifeLostSound = new Tone.Synth({ oscillator: { type: "sawtooth" }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.05, release: 0.1 }, volume: -12 }).toDestination(); /* mindTwistCorrectSound = new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.05, release: 0.2 }, volume: -15 }).toDestination(); mindTwistIncorrectSound = new Tone.Synth({ oscillator: { type: "square" }, envelope: { attack: 0.02, decay: 0.2, sustain: 0, release: 0.2 }, volume: -18 }).toDestination(); */ lootBoxSound = new Tone.PolySynth(Tone.Synth, { oscillator: { type: "triangle" }, envelope: { attack: 0.05, decay: 0.4, sustain: 0.1, release: 0.5 }, volume: -7 }).toDestination(); dailyBonusSound = new Tone.PolySynth(Tone.Synth, { oscillator: { type: "sine" }, envelope: { attack: 0.05, decay: 0.3, sustain: 0.1, release: 0.5 }, volume: -6 }).toDestination(); medalSound = new Tone.PolySynth(Tone.Synth, { oscillator: { type: "square" }, envelope: { attack: 0.02, decay: 0.3, sustain: 0.1, release: 0.4 }, volume: -8 }).toDestination(); clickSound = new Tone.MembraneSynth({ pitchDecay: 0.008, octaves: 2, envelope: { attack: 0.0006, decay: 0.2, sustain: 0 } }).toDestination(); timerTickSound = new Tone.MembraneSynth({ pitchDecay: 0.01, octaves: 1.5, envelope: { attack: 0.001, decay: 0.1, sustain: 0 }, volume: -25 }).toDestination(); simonPadSounds.red = new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.01, release: 0.1 }, volume: -12 }).toDestination(); simonPadSounds.green = new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.01, release: 0.1 }, volume: -12 }).toDestination(); simonPadSounds.blue = new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.01, release: 0.1 }, volume: -12 }).toDestination(); simonPadSounds.yellow = new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.01, release: 0.1 }, volume: -12 }).toDestination(); synthsInitialized = true; } catch (e) { console.error("Error initializing AudioContext or synths:", e); } }
        const congratulations = [ "¡Bien hecho, {name}! 🎉 ¡Nivel {level} desbloqueado!", "¡Excelente trabajo! 🌟 ¡Pasaste al Nivel {level}!", "¡Fantástico, {name}! 🚀 ¡Ya estás en el Nivel {level}!", "¡Increíble! ✨ ¡El Nivel {level} te espera, {name}!", "¡Sigue así, {name}! 🔥 ¡Nivel {level} superado con éxito!", "¡Eres una estrella, {name}! 🌠 ¡Bienvenido al Nivel {level}!", "¡Lo lograste, {name}! 💪 ¡A conquistar el Nivel {level}!" ];

        function getUserStats() { return currentLoggedInPlayer ? allUsersData[currentLoggedInPlayer].stats : null; }
        function countUniqueLoginDays(stats) { if (!stats || !stats.loginHistory) return 0; const uniqueDays = new Set(stats.loginHistory); return uniqueDays.size; }
        function playSound(sound, note, duration = '8n', timeOffset = '+0') { if (synthsInitialized && sound) { try { if (sound instanceof Tone.PolySynth) { sound.triggerAttackRelease(note, duration, Tone.now() + parseFloat(timeOffset.replace('+', ''))); } else if (sound instanceof Tone.NoiseSynth || sound instanceof Tone.MembraneSynth) { sound.triggerAttackRelease(duration, Tone.now() + parseFloat(timeOffset.replace('+', ''))); } else { sound.triggerAttackRelease(note, duration, Tone.now() + parseFloat(timeOffset.replace('+', ''))); } } catch (e) { console.error("Error playing sound:", e); } } }
        function playClickSound() { if(synthsInitialized && clickSound) playSound(clickSound, null, '16n'); }

        function showScreen(screenId) {
            playClickSound();
            ['welcome', 'selection', 'math', /*'mindtwist',*/ 'simon'].forEach(id => { // 'mindtwist' comentado
                const el = document.getElementById(id + '-screen') || document.getElementById(id + '-game-container');
                if (el) el.style.display = 'none';
            });
            clearTimeout(mathTimerId); /* clearTimeout(mindTwistTimerId); */ // mindTwistTimerId comentado
            if (simonGameActive) { simonGameActive = false; simonStartButton.disabled = false; Object.values(simonPadElements).forEach(pad => pad.disabled = true); }
            // Comentada la limpieza de MindTwist
            // const userStats = getUserStats();
            // if (activeGame === 'mindtwist' && userStats && userStats.mindtwist.currentLevel < mindTwistLevels.length) {
            //      const currentLevelConfig = mindTwistLevels[userStats.mindtwist.currentLevel];
            //      if (currentLevelConfig && currentLevelConfig.cleanup) { currentLevelConfig.cleanup(); }
            // }
            let targetScreen;
            if (screenId === 'welcome') { targetScreen = welcomeScreen; playerNameInput.value = ''; playerPasswordInput.value = ''; authErrorMessage.style.display = 'none';
            } else if (screenId === 'selection') { if (!currentLoggedInPlayer) { showScreen('welcome'); return; } updateSelectionScreenStats(); checkDailyBonus(); updateMedalsDisplay(); updateLeaderboardDisplay(); targetScreen = selectionScreen;
            } else if (screenId === 'math') targetScreen = mathGameContainer;
            // else if (screenId === 'mindtwist') targetScreen = mindTwistGameContainer; // Comentado
            else if (screenId === 'simon') targetScreen = simonGameContainer;
            if(targetScreen) targetScreen.style.display = 'flex';
            activeGame = screenId;
        }

        function handleLoginOrCreate() { initializeAudio(); playClickSound(); const username = playerNameInput.value.trim(); const password = playerPasswordInput.value; authErrorMessage.style.display = 'none'; if (!username) { authErrorMessage.textContent = '¡Tu nombre es esencial!'; authErrorMessage.style.display = 'block'; return; } if (username.length > 20) { authErrorMessage.textContent = 'Nombre demasiado largo (Máx. 20).'; authErrorMessage.style.display = 'block'; return; } if (!password) { authErrorMessage.textContent = 'Contraseña requerida.'; authErrorMessage.style.display = 'block'; return; } if (password.length < 4) { authErrorMessage.textContent = 'Contraseña muy corta (Mín. 4).'; authErrorMessage.style.display = 'block'; return; }
            if (allUsersData[username]) { if (allUsersData[username].password === password) { currentLoggedInPlayer = username; showNotification(`¡Bienvenido de nuevo, ${username}!`, 'success'); } else { authErrorMessage.textContent = 'Contraseña incorrecta.'; authErrorMessage.style.display = 'block'; return; }
            } else { allUsersData[username] = { password: password, stats: defaultPlayerStats(), }; currentLoggedInPlayer = username; showNotification(`¡Cuenta creada para ${username}! ¡Bienvenido!`, 'success'); }
            displayPlayerNameSelection.textContent = currentLoggedInPlayer; mathDisplayPlayerName.textContent = currentLoggedInPlayer;
            // mindtwistDisplayPlayerName.textContent = currentLoggedInPlayer; // Comentado
            const today = new Date().toISOString().split('T')[0]; const userStats = getUserStats(); if (!userStats.lastLoginDate || userStats.lastLoginDate !== today) { userStats.lastLoginDate = today; if (!userStats.loginHistory.includes(today)) { userStats.loginHistory.push(today); if (userStats.loginHistory.length > 30) userStats.loginHistory.shift(); } }
            saveAllUsersData(); showScreen('selection'); checkAndAwardMedal("first_game");
        }
        function logout() { playClickSound(); if (currentLoggedInPlayer) { showNotification(`¡Hasta pronto, ${currentLoggedInPlayer}!`, 'event'); saveAllUsersData(); currentLoggedInPlayer = null; } showScreen('welcome'); }

        function selectGame(gameType) {
            playClickSound();
            if (!currentLoggedInPlayer) { showScreen('welcome'); return; }
            activeGame = gameType;
            if (gameType === 'math') { startMathGame(); showScreen('math'); }
            // else if (gameType === 'mindtwist') { startMindTwistGame(); showScreen('mindtwist'); } // Comentado
            else if (gameType === 'simon') { startSimonGame(); showScreen('simon'); }
            else if (gameType === 'numberMemory') { startNumberMemoryGame(); }
            else if (gameType === 'memoryPairs') { startMemoryPairsGame(); }
            else if (gameType === 'slidingPuzzle') { startSlidingPuzzleGame(); }
        }

        function updateSelectionScreenStats() { const userStats = getUserStats(); if (!userStats) return; summaryMathBestStreak.textContent = userStats.math.bestStreak; /* summaryMindtwistSolved.textContent = userStats.mindtwist.solvedCount; */ summarySimonScore.textContent = userStats.simon.highestScore; }

        function startMathGame() { const userStats = getUserStats(); if (!userStats) return; playSound(gameStartSound, 'C4', '0.5s'); userStats.math.currentLevel = userStats.math.currentLevel > 0 ? userStats.math.currentLevel : 1; userStats.math.playerLives = INITIAL_LIVES; userStats.math.correctStreak = 0; userStats.math.questionsInLevel = 0; const rachaBonusIndex = userStats.inventory.indexOf("bonus_racha_mates"); if (rachaBonusIndex > -1) { userStats.math.correctStreak = 1; userStats.inventory.splice(rachaBonusIndex, 1); showNotification("¡Bonus de racha inicial aplicado!", "event", 2000); } updateMathGameDisplay(); nextMathProblem(); userStats.math.totalGamesPlayed++; saveAllUsersData(); checkAndAwardMedal("first_game"); }
        function getMathTimeForCurrentLevel() { const userStats = getUserStats(); let time = MATH_BASE_TIME_PER_QUESTION - (userStats.math.currentLevel -1) * MATH_TIME_REDUCTION_PER_LEVEL; time = Math.max(time, MATH_MIN_TIME_PER_QUESTION); if (userStats.math.questionsInLevel === 0) { const tiempoBonusIndex = userStats.inventory.indexOf("bonus_tiempo_inicio_mates"); if (tiempoBonusIndex > -1) { time += 5; userStats.inventory.splice(tiempoBonusIndex, 1); showNotification("¡+5s de bonus de tiempo inicial!", "event", 2000); } } return time; }
        function nextMathProblem() { const userStats = getUserStats(); if (userStats.math.playerLives <= 0) { gameOverMath(); return; } clearTimeout(mathTimerId); mathTimeLeft = getMathTimeForCurrentLevel(); mathUserAnswerInput.value = ''; mathUserAnswerInput.focus(); mathAnswerExplanationDisplay.style.display = 'none'; mathGameResultDisplay.textContent = ''; mathGameResultDisplay.className = 'result'; mathTimerWrapper.classList.remove('text-red-500'); generateMathProblem(); updateMathGameDisplay(); mathTimerId = setInterval(updateMathTimer, 1000); }
        function generateMathProblem() { const userStats = getUserStats(); const level = userStats.math.currentLevel; let num1, num2, operator, problemText; if (level <= 3) { operator = Math.random() < 0.5 ? '+' : '-'; num1 = Math.floor(Math.random() * 10) + 1; num2 = Math.floor(Math.random() * 10) + 1; if (operator === '-' && num1 < num2) [num1, num2] = [num2, num1]; } else if (level <= 7) { const r = Math.random(); operator = r < 0.4 ? '+' : (r < 0.8 ? '-' : '*'); if (operator === '*') { num1 = Math.floor(Math.random() * 9) + 2; num2 = Math.floor(Math.random() * 9) + 2; } else { num1 = Math.floor(Math.random() * 20 * (level/3)) + 1; num2 = Math.floor(Math.random() * 20 * (level/3)) + 1; if (operator === '-' && num1 < num2) [num1, num2] = [num2, num1]; } } else if (level <= 12) { const r = Math.random(); operator = r < 0.3 ? '+' : (r < 0.5 ? '-' : (r < 0.85 ? '*' : '/')); if (operator === '*') { num1 = Math.floor(Math.random() * 10) + 5; num2 = Math.floor(Math.random() * 10) + (level > 9 ? 5 : 2); } else if (operator === '/') { num2 = Math.floor(Math.random() * 8) + 2; mathCorrectAnswer = Math.floor(Math.random() * 8) + 2; num1 = num2 * mathCorrectAnswer; } else { num1 = Math.floor(Math.random() * 50 * (level/6)) + 10; num2 = Math.floor(Math.random() * 50 * (level/6)) + 10; if (operator === '-' && num1 < num2) [num1, num2] = [num2, num1]; } } else { const r = Math.random(); operator = r < 0.4 ? '*' : (r < 0.7 ? '/' : '+'); if (operator === '*') { num1 = Math.floor(Math.random() * 15) + 5; num2 = Math.floor(Math.random() * 15) + 5; } else if (operator === '/') { num2 = Math.floor(Math.random() * 10) + 2; mathCorrectAnswer = Math.floor(Math.random() * 12) + 2; num1 = num2 * mathCorrectAnswer; } else { num1 = Math.floor(Math.random() * (50 + level * 5)) + 20; num2 = Math.floor(Math.random() * (50 + level * 5)) + 20; if (operator === '-' && num1 < num2) [num1, num2] = [num2, num1]; } } if (operator !== '/') { switch (operator) { case '+': mathCorrectAnswer = num1 + num2; break; case '-': mathCorrectAnswer = num1 - num2; break; case '*': mathCorrectAnswer = num1 * num2; break; } } mathCurrentProblemDetails = {num1, num2, operator}; problemText = `<span>${num1}</span> <span style="color: #667eea;">${operator}</span> <span>${num2}</span> = ?`; mathProblemDisplay.innerHTML = problemText; }
        function checkMathAnswer() { const userStats = getUserStats(); clearTimeout(mathTimerId); const userAnswer = parseInt(mathUserAnswerInput.value); if (isNaN(userAnswer)) { showMathResult("¡Ingresa un número!", "incorrect"); userStats.math.playerLives--; playSound(lifeLostSound, 'C3', '0.1s'); setTimeout(nextMathProblem, 1500); return; } if (userAnswer === mathCorrectAnswer) { userStats.math.correctStreak++; userStats.math.questionsInLevel++; userStats.math.totalCorrect++; if (userStats.math.correctStreak > userStats.math.bestStreak) { userStats.math.bestStreak = userStats.math.correctStreak; showNotification(`¡Nueva mejor racha: ${userStats.math.bestStreak}!`, "streak", 2500); addToLeaderboard(currentLoggedInPlayer, userStats.math.bestStreak, 'math'); } showMathResult("¡Correcto! 🎉", "correct"); playSound(correctSound, 'C5', '0.1s'); checkAndAwardMedal("math_first_correct"); if (userStats.math.questionsInLevel >= MATH_CORRECT_PER_LEVEL) { levelUpMath(); } else { setTimeout(nextMathProblem, 1000); } } else { userStats.math.playerLives--; userStats.math.correctStreak = 0; userStats.math.totalIncorrect++; showMathResult(`Incorrecto. La respuesta era ${mathCorrectAnswer}.`, "incorrect"); showMathExplanation(); playSound(incorrectSound, 'C3', '0.2s'); playSound(lifeLostSound, 'A2', '0.1s', '+0.1'); if (userStats.math.playerLives <= 0) { setTimeout(gameOverMath, 2000); } else { setTimeout(nextMathProblem, 2500); } } updateMathGameDisplay(); checkAndAwardAllMedals(); saveAllUsersData(); }
        function showMathExplanation() { const {num1, num2, operator} = mathCurrentProblemDetails; let explanation = `<strong>Explicación:</strong> `; switch(operator) { case '+': explanation += `Sumar ${num1} y ${num2} da como resultado <code>${num1} + ${num2} = ${mathCorrectAnswer}</code>.`; break; case '-': explanation += `Restar ${num2} de ${num1} da como resultado <code>${num1} - ${num2} = ${mathCorrectAnswer}</code>.`; break; case '*': explanation += `Multiplicar ${num1} por ${num2} da como resultado <code>${num1} * ${num2} = ${mathCorrectAnswer}</code>.`; break; case '/': explanation += `Dividir ${num1} entre ${num2} da como resultado <code>${num1} / ${num2} = ${mathCorrectAnswer}</code>. (Porque ${num2} * ${mathCorrectAnswer} = ${num1}).`; break; } mathAnswerExplanationDisplay.innerHTML = explanation; mathAnswerExplanationDisplay.style.display = 'block'; }
        function levelUpMath() { const userStats = getUserStats(); userStats.math.currentLevel++; userStats.math.questionsInLevel = 0; userStats.math.correctStreak = 0; showMathResult(getCongratulationsMessage(), "level-up", 2500); playSound(levelUpSound, ['C4', 'E4', 'G4', 'C5'], '0.5s'); if (userStats.math.currentLevel > MATH_MAX_LEVEL) { showMathResult("¡Has dominado Mates Rápidas!", "correct", 3000); setTimeout(() => showScreen('selection'), 3000); return; } if (userStats.math.playerLives < INITIAL_LIVES) { userStats.math.playerLives++; showNotification("+1 Vida por subir de nivel!", "event", 1500); } setTimeout(nextMathProblem, 2500); checkAndAwardAllMedals(); }
        function levelDownMath() { const userStats = getUserStats(); if (userStats.math.currentLevel > 1) { userStats.math.currentLevel--; userStats.math.questionsInLevel = 0; userStats.math.correctStreak = 0; showMathResult("¡Oh no! Has bajado al Nivel " + userStats.math.currentLevel, "level-down", 2000); playSound(levelDownSound, null, '0.3s'); } else { showMathResult("¡Cuidado! Estás en el primer nivel.", "incorrect", 2000); } updateMathGameDisplay(); }
        function updateMathTimer() { const userStats = getUserStats(); mathTimeLeft--; mathTimeLeftDisplay.textContent = mathTimeLeft; if (mathTimeLeft <= 5 && mathTimeLeft > 0) { mathTimerWrapper.classList.add('text-red-500'); if (synthsInitialized && timerTickSound && mathTimeLeft % 2 === 0) playSound(timerTickSound, null, '32n'); } else { mathTimerWrapper.classList.remove('text-red-500'); } if (mathTimeLeft <= 0) { clearTimeout(mathTimerId); showMathResult("¡Se acabó el tiempo! ⏰", "incorrect"); userStats.math.playerLives--; userStats.math.correctStreak = 0; playSound(incorrectSound, 'A2', '0.3s'); playSound(lifeLostSound, 'G2', '0.1s', '+0.1'); if (userStats.math.playerLives <= 0) { setTimeout(gameOverMath, 2000); } else { setTimeout(nextMathProblem, 2000); } updateMathGameDisplay(); saveAllUsersData(); } }
        function updateMathGameDisplay() { const userStats = getUserStats(); if (!userStats) return; mathPlayerLivesDisplay.textContent = userStats.math.playerLives; mathCurrentLevelDisplay.textContent = userStats.math.currentLevel; mathCorrectStreakDisplay.textContent = userStats.math.correctStreak; mathCorrectPerLevelDisplay.textContent = MATH_CORRECT_PER_LEVEL; mathBestStreakDisplay.textContent = userStats.math.bestStreak; mathTimeLeftDisplay.textContent = mathTimeLeft; const progress = userStats.math.playerLives > 0 ? (userStats.math.questionsInLevel / MATH_CORRECT_PER_LEVEL) * 100 : 0; mathProgressBarFill.style.width = `${progress}%`; mathProgressBarFill.textContent = `${Math.round(progress)}%`; }
        function showMathResult(message, type, duration = 1500) { mathGameResultDisplay.textContent = message; mathGameResultDisplay.className = 'result ' + type; mathGameResultDisplay.style.animation = 'none'; mathGameResultDisplay.offsetHeight; mathGameResultDisplay.style.animation = null; if (type === "incorrect" || type === "level-down") { mathGameResultDisplay.classList.add('shake'); } }
        function getCongratulationsMessage() { const messageTemplate = congratulations[Math.floor(Math.random() * congratulations.length)]; return messageTemplate.replace("{name}", currentLoggedInPlayer).replace("{level}", getUserStats().math.currentLevel); }
        function gameOverMath() { const userStats = getUserStats(); clearTimeout(mathTimerId); showMathResult(`¡Juego Terminado! Mejor racha: ${userStats.math.bestStreak}`, "incorrect", 3000); playSound(levelDownSound, null, '0.5s'); if (userStats.math.currentLevel > 1) levelDownMath(); if (userStats.math.bestStreak >= 3 && Math.random() < MATH_GAME_LOOT_BOX_PROBABILITY) { setTimeout(triggerLootBox, 1500); } setTimeout(() => { showScreen('selection'); userStats.math.correctStreak = 0; userStats.math.questionsInLevel = 0; }, 3000); saveAllUsersData(); }

        // --- Mind Twist Game Logic (Comentado) ---
        /*
        function startMindTwistGame() { // ... }
        function loadMindTwistLevel(levelIndex) { // ... }
        function mindTwistAnswer(isCorrect) { // ... }
        function nextMindTwistLevel() { // ... }
        function updateMindTwistTimerDisplay() { // ... }
        function updateMindTwistTimerTick() { // ... }
        function gameOverMindTwist() { // ... }
        function cleanupMindTwist_Generic() { // ... }
        function setupMindTwist_BiggestObject(area) { // ... }
        function checkMindTwist_BiggestObject(selectedObject) { // ... }
        // ... (resto de funciones de niveles de MindTwist comentadas)
        */

        function startSimonGame() { const userStats = getUserStats(); if (!userStats) return; playSound(gameStartSound, 'E4', '0.5s'); simonGameActive = true; simonSequence = []; simonPlayerSequence = []; simonCurrentScore = 0; simonFeedbackDisplay.textContent = "Observa la secuencia..."; simonScoreDisplay.textContent = simonCurrentScore; simonStartButton.disabled = true; userStats.simon.totalGamesPlayed++; checkAndAwardMedal("first_game"); checkAndAwardMedal("simon_first_game"); saveAllUsersData(); setTimeout(simonNextComputerTurn, SIMON_ROUND_DELAY); }
        function simonNextComputerTurn() { if (!simonGameActive) return; simonTurn = 'computer'; simonPlayerSequence = []; simonFeedbackDisplay.textContent = "Observa..."; disableSimonPads(); const nextColor = SIMON_COLORS[Math.floor(Math.random() * SIMON_COLORS.length)]; simonSequence.push(nextColor); playSimonSequence(); }
        async function playSimonSequence() { await delay(SIMON_INTER_FLASH_DELAY / 2); for (const color of simonSequence) { if (!simonGameActive) return; await flashSimonPad(color, SIMON_FLASH_DURATION); await delay(SIMON_INTER_FLASH_DELAY); } if (simonGameActive) startPlayerTurnSimon(); }
        async function flashSimonPad(color, duration) { const padElement = simonPadElements[color]; padElement.classList.add('active'); playSound(simonPadSounds[color], getNoteForSimonColor(color), `${duration/1000}s`); await delay(duration); padElement.classList.remove('active'); }
        function getNoteForSimonColor(color) { switch(color) { case 'red': return 'C4'; case 'green': return 'E4'; case 'blue': return 'G4'; case 'yellow': return 'B4'; default: return 'C4'; } }
        function startPlayerTurnSimon() { simonTurn = 'player'; simonFeedbackDisplay.textContent = "¡Tu turno!"; enableSimonPads(); }
        function handleSimonPadClick(event) { if (!simonGameActive || simonTurn !== 'player') return; const clickedColor = event.target.dataset.color; if (!clickedColor) return; flashSimonPad(clickedColor, 150); simonPlayerSequence.push(clickedColor); const currentStep = simonPlayerSequence.length - 1; if (simonPlayerSequence[currentStep] !== simonSequence[currentStep]) { gameOverSimon("¡Incorrecto!"); return; } if (simonPlayerSequence.length === simonSequence.length) { simonCurrentScore += simonSequence.length; simonScoreDisplay.textContent = simonCurrentScore; playSound(correctSound, 'C5', '0.1s'); checkAndAwardMedal("simon_score_50"); if(simonSequence.length >= 5) checkAndAwardMedal("simon_sequence_5"); disableSimonPads(); simonFeedbackDisplay.textContent = "¡Bien hecho!"; setTimeout(simonNextComputerTurn, SIMON_ROUND_DELAY); } }
        function gameOverSimon(message) { playSound(incorrectSound, 'C3', '0.3s'); simonFeedbackDisplay.textContent = `${message} Puntuación final: ${simonCurrentScore}.`; simonGameActive = false; simonStartButton.disabled = false; disableSimonPads(); const userStats = getUserStats(); if (simonCurrentScore > userStats.simon.highestScore) { userStats.simon.highestScore = simonCurrentScore; showNotification(`¡Nuevo récord en Simón: ${simonCurrentScore} puntos!`, 'streak'); addToLeaderboard(currentLoggedInPlayer, simonCurrentScore, 'simon'); } if (simonSequence.length -1 > userStats.simon.longestSequence) { userStats.simon.longestSequence = Math.max(0, simonSequence.length -1) ; } saveAllUsersData(); updateSelectionScreenStats(); }
        function enableSimonPads() { Object.values(simonPadElements).forEach(pad => pad.disabled = false); }
        function disableSimonPads() { Object.values(simonPadElements).forEach(pad => pad.disabled = true); }
        function delay(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

        function startNumberMemoryGame() { showNotification("Memoria de Números - ¡Próximamente!", "event"); showScreen('selection'); }
        function startMemoryPairsGame() { showNotification("Parejas de Memoria - ¡Próximamente!", "event"); showScreen('selection'); }
        function startSlidingPuzzleGame() { showNotification("Laberinto Deslizante - ¡Próximamente!", "event"); showScreen('selection'); }

        function triggerLootBox() { const userStats = getUserStats(); playSound(lootBoxSound, ['C4', 'E4', 'G4'], '0.4s'); lootBoxModal.classList.add('visible'); lootBoxRewardText.textContent = "Abriendo..."; setTimeout(() => { const rewards = ["+1 Vida Extra (Mates)", "Bonus de Racha (Mates)", "Bonus de Tiempo Inicial (Mates)"]; const randomReward = rewards[Math.floor(Math.random() * rewards.length)]; lootBoxRewardText.textContent = `¡Has ganado: ${randomReward}!`; let notificationMsg = `¡Recompensa obtenida: ${randomReward}!`; if (randomReward.includes("Vida Extra") && userStats.math.playerLives < INITIAL_LIVES + 2) { userStats.math.playerLives++; } else if (randomReward.includes("Racha")) { userStats.inventory.push("bonus_racha_mates"); notificationMsg = "¡Bonus de Racha añadido a tu inventario!"; } else if (randomReward.includes("Tiempo Inicial")) { userStats.inventory.push("bonus_tiempo_inicio_mates"); notificationMsg = "¡Bonus de Tiempo Inicial añadido!"; } showNotification(notificationMsg, "event", 2500); if (activeGame === 'math') updateMathGameDisplay(); saveAllUsersData(); }, 1500); }
        function closeLootBox() { playClickSound(); lootBoxModal.classList.remove('visible'); }
        function showNotification(message, type = 'success', duration = 3000) { notificationDisplay.textContent = message; notificationDisplay.className = 'notification show ' + type; setTimeout(() => { notificationDisplay.classList.remove('show'); }, duration); }

        const MAX_LEADERBOARD_ENTRIES = 5;
        let globalLeaderboard = { math: [], simon: [] };

        function updateLeaderboardDisplay() {
            leaderboardList.innerHTML = '';
            const mathLeaderboard = (globalLeaderboard.math || []).sort((a, b) => b.score - a.score).slice(0, MAX_LEADERBOARD_ENTRIES);
            const simonLeaderboard = (globalLeaderboard.simon || []).sort((a, b) => b.score - a.score).slice(0, MAX_LEADERBOARD_ENTRIES);
            if (mathLeaderboard.length === 0 && simonLeaderboard.length === 0) { leaderboardList.innerHTML = '<li class="leaderboard-item" style="text-align:center; color:#888;">Aún no hay puntajes.</li>'; return; }
            if(mathLeaderboard.length > 0) { const mathTitle = document.createElement('li'); mathTitle.innerHTML = `<strong>Mates (Mejor Racha)</strong>`; mathTitle.style.textAlign = 'center'; mathTitle.style.fontWeight = 'bold'; mathTitle.style.paddingBottom = '5px'; mathTitle.style.color = '#5A67D8'; leaderboardList.appendChild(mathTitle); mathLeaderboard.forEach(entry => { const li = document.createElement('li'); li.classList.add('leaderboard-item'); if (entry.name === currentLoggedInPlayer) { li.classList.add('you'); } li.innerHTML = `<span>${entry.name}</span> <strong>${entry.score}</strong>`; leaderboardList.appendChild(li); }); }
            if(simonLeaderboard.length > 0) { const simonTitle = document.createElement('li'); simonTitle.innerHTML = `<strong>Simón (Puntuación Máx.)</strong>`; simonTitle.style.textAlign = 'center'; simonTitle.style.fontWeight = 'bold'; simonTitle.style.paddingTop = '10px'; simonTitle.style.paddingBottom = '5px'; simonTitle.style.color = '#38A169'; leaderboardList.appendChild(simonTitle); simonLeaderboard.forEach(entry => { const li = document.createElement('li'); li.classList.add('leaderboard-item'); if (entry.name === currentLoggedInPlayer) { li.classList.add('you'); } li.innerHTML = `<span>${entry.name}</span> <strong>${entry.score}</strong>`; leaderboardList.appendChild(li); }); }
        }
        function addToLeaderboard(name, score, gameType) { if (!globalLeaderboard[gameType]) globalLeaderboard[gameType] = []; const board = globalLeaderboard[gameType]; const existingEntryIndex = board.findIndex(entry => entry.name === name); if (existingEntryIndex !== -1) { if (score > board[existingEntryIndex].score) { board[existingEntryIndex].score = score; } else { return; } } else { board.push({ name, score }); } board.sort((a, b) => b.score - a.score); if (board.length > MAX_LEADERBOARD_ENTRIES * 2) { globalLeaderboard[gameType] = board.slice(0, MAX_LEADERBOARD_ENTRIES * 2); } updateLeaderboardDisplay(); saveAllUsersData(); }

        function updateMedalsDisplay() { const userStats = getUserStats(); if (!userStats) return; medalsList.innerHTML = ''; MEDALS.forEach(medal => { const isUnlocked = userStats.medals.includes(medal.id); const medalDiv = document.createElement('div'); medalDiv.classList.add('medal-item'); medalDiv.textContent = medal.icon; const tooltipSpan = document.createElement('span'); tooltipSpan.classList.add('medal-tooltip'); tooltipSpan.textContent = `${medal.name}${isUnlocked ? '' : ' (Bloqueada)'} - ${medal.description}`; medalDiv.appendChild(tooltipSpan); if (!isUnlocked) { medalDiv.classList.add('locked'); } medalsList.appendChild(medalDiv); }); }
        function checkAndAwardMedal(medalId) { const userStats = getUserStats(); const medal = MEDALS.find(m => m.id === medalId); if (medal && !userStats.medals.includes(medalId) && medal.condition(userStats)) { userStats.medals.push(medalId); showNotification(`¡Medalla Desbloqueada: ${medal.name} ${medal.icon}!`, 'medal', 4000); playSound(medalSound, ['C5', 'G5', 'E5'], '0.4s'); updateMedalsDisplay(); saveAllUsersData(); } }
        function checkAndAwardAllMedals() { const userStats = getUserStats(); if(!userStats) return; MEDALS.forEach(medal => { if (!userStats.medals.includes(medal.id) && medal.condition(userStats)) { checkAndAwardMedal(medal.id); } }); }
        function checkDailyBonus() { const userStats = getUserStats(); if (!userStats) return; const today = new Date(); const todayDay = today.getDate(); const lastBonusDay = userStats.dailyBonusDay; if (!lastBonusDay || lastBonusDay !== todayDay) { dailyBonusCardContainer.style.display = 'block'; dailyBonusContainer.style.display = 'block'; const bonusOptions = ["+1 Vida (Mates)", "Bonus de Racha (Mates)", "Bonus de Tiempo Inicial (Mates)"]; const randomBonus = bonusOptions[Math.floor(Math.random() * bonusOptions.length)]; dailyBonusMessage.textContent = `¡Tu recompensa de hoy es: ${randomBonus}!`; dailyBonusContainer.dataset.pendingBonus = randomBonus; } else { dailyBonusCardContainer.style.display = 'none'; dailyBonusContainer.style.display = 'none'; } }
        function collectDailyBonus() { playClickSound(); const userStats = getUserStats(); const pendingBonus = dailyBonusContainer.dataset.pendingBonus; if (pendingBonus) { let notificationMsg = `¡Bonificación reclamada: ${pendingBonus}!`; playSound(dailyBonusSound, ['D4', 'F#4', 'A4'], '0.5s'); if (pendingBonus.includes("Vida") && userStats.math.playerLives < INITIAL_LIVES + 2) { userStats.math.playerLives++; } else if (pendingBonus.includes("Racha")) { userStats.inventory.push("bonus_racha_mates"); notificationMsg = "¡Bonus de Racha añadido a tu inventario!"; } else if (pendingBonus.includes("Tiempo Inicial")) { userStats.inventory.push("bonus_tiempo_inicio_mates"); notificationMsg = "¡Bonus de Tiempo Inicial añadido!"; } showNotification(notificationMsg, 'event', 3000); userStats.dailyBonusDay = new Date().getDate(); dailyBonusCardContainer.style.display = 'none'; dailyBonusContainer.style.display = 'none'; delete dailyBonusContainer.dataset.pendingBonus; if (activeGame === 'math') updateMathGameDisplay(); saveAllUsersData(); } }

        function saveAllUsersData() { try { const dataToSave = { users: allUsersData, leaderboard: globalLeaderboard }; localStorage.setItem('mentalChallengesUserData_v5_noMindTwist', JSON.stringify(dataToSave)); } catch (e) { console.error("Error saving data:", e); showNotification("Error al guardar progreso.", "error", 5000); } } // Cambiado el nombre de la clave de guardado
        function loadAllUsersData() { try { const savedData = localStorage.getItem('mentalChallengesUserData_v5_noMindTwist'); if (savedData) { const parsedData = JSON.parse(savedData); allUsersData = parsedData.users || {}; globalLeaderboard = parsedData.leaderboard || { math: [], simon: [] }; } else { allUsersData = {}; globalLeaderboard = { math: [], simon: [] }; } } catch (e) { console.error("Error loading data:", e); showNotification("Error al cargar datos guardados.", "error", 5000); allUsersData = {}; globalLeaderboard = { math: [], simon: [] }; } }

        mathUserAnswerInput.addEventListener('keypress', function(event) { if (event.key === 'Enter') { checkMathAnswer(); } });
        Object.values(simonPadElements).forEach(pad => {
            pad.addEventListener('click', handleSimonPadClick);
        });

        window.onload = () => {
            loadAllUsersData();
            updateLeaderboardDisplay();
            showScreen('welcome');
        };
    </script>
</body>
</html>
