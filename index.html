<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desaf√≠os Mentales - Edici√≥n Estrat√©gica Avanzada</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        /* Estilos Generales (del juego principal) */
        body {
            font-family: 'Nunito', ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            line-height: 1.6;
            color: #4A5568;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
            overflow-x: hidden;
        }
        .container {
            background-color: rgba(255, 255, 255, 0.97);
            padding: 25px 35px;
            border-radius: 20px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2), 0 8px 15px rgba(0,0,0,0.18);
            text-align: center;
            max-width: 750px;
            width: 100%;
            box-sizing: border-box;
            transition: transform 0.3s ease-out;
            min-height: 680px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        .container:hover {
            transform: translateY(-6px);
        }

        button, .button-style {
            color: white; padding: 12px 24px; border: none; border-radius: 10px; cursor: pointer; font-size: 1em;
            transition: background-color 0.2s ease, transform 0.15s ease, box-shadow 0.2s ease;
            text-transform: uppercase; letter-spacing: 0.8px; box-shadow: 0 5px 8px rgba(0,0,0,0.12);
            margin: 8px; font-family: 'Fredoka One', cursive; font-weight: 400;
        }
        button:hover, .button-style:hover { transform: translateY(-3px) scale(1.03); box-shadow: 0 7px 12px rgba(0,0,0,0.18); }
        button:active, .button-style:active { transform: translateY(-1px) scale(0.98); box-shadow: 0 3px 6px rgba(0,0,0,0.1); }
        button:disabled, .button-style:disabled { background-color: #A0AEC0 !important; cursor: not-allowed; transform: none; box-shadow: 0 5px 8px rgba(0,0,0,0.08);}


        .welcome-screen { display: flex; flex-direction: column; align-items: center; animation: fadeIn 0.5s ease-out; }
        .welcome-screen h1 { color: #5A67D8; margin-bottom: 15px; font-size: 2.6em; text-shadow: 1px 1px 3px rgba(0,0,0,0.1); font-family: 'Fredoka One', cursive; }
        .welcome-screen p { font-size: 1.15em; margin-bottom: 12px; color: #5f6c80; }
        .welcome-screen input[type="text"], .welcome-screen input[type="password"] {
            padding: 14px 18px; margin-bottom: 18px; border: 2px solid #CBD5E0; border-radius: 10px;
            font-size: 1.2em; width: 90%; max-width: 320px; text-align: center; box-sizing: border-box;
            transition: border-color 0.3s ease, box-shadow 0.3s ease; font-family: 'Nunito', sans-serif;
        }
        .welcome-screen input[type="text"]:focus, .welcome-screen input[type="password"]:focus {
            border-color: #5A67D8; box-shadow: 0 0 0 4px rgba(90, 103, 216, 0.25); outline: none;
        }
        .welcome-screen button { background-color: #48BB78; margin-top: 10px; }
        .welcome-screen button:hover { background-color: #3f9e6a; }
        .auth-error-message { color: #E53E3E; font-size: 0.95em; margin-top: -10px; margin-bottom: 10px; display: none; font-weight: 600; }

        .selection-screen { display: none; flex-direction: column; align-items: center; width: 100%; animation: slideInUp 0.6s ease-out; }
        .selection-screen h2 { color: #3a4b60; margin-bottom: 10px; font-size: 2.2em; font-family: 'Fredoka One', cursive; }
        .selection-screen .greeting-subtext { font-size: 1.1em; color: #6b7a90; margin-bottom: 15px; }
        .selection-screen .logout-button { background-color: #A0AEC0; font-size: 0.8em; padding: 8px 15px; margin-top: 0; margin-bottom: 15px; }
        .selection-screen .logout-button:hover { background-color: #7f8c9b; }
        .selection-screen .game-selection-buttons { margin-bottom: 25px; display: flex; flex-wrap: wrap; justify-content: center;}
        .selection-screen .game-selection-buttons button { background-color: #4299E1; min-width: 220px; margin: 8px;}
        .selection-screen .game-selection-buttons button:hover { background-color: #3582c0; }
        .selection-screen .game-selection-buttons button.game-mindtwist { background-color: #ED8936; }
        .selection-screen .game-selection-buttons button.game-mindtwist:hover { background-color: #d57b2f; }
        .selection-screen .game-selection-buttons button.game-simon { background-color: #38A169; }
        .selection-screen .game-selection-buttons button.game-simon:hover { background-color: #2f855a; }
        .selection-screen .game-selection-buttons button.game-number-memory { background-color: #805AD5; }
        .selection-screen .game-selection-buttons button.game-number-memory:hover { background-color: #6b46c1; }
        .selection-screen .game-selection-buttons button.upcoming { background-color: #718096; }
        .selection-screen .game-selection-buttons button.upcoming:hover { background-color: #5a6470; }


        .selection-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; width: 100%; max-width: 680px; margin-top: 20px; }
        .selection-card { background-color: #f7faff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); text-align: left; transition: transform 0.2s ease-out, box-shadow 0.2s ease-out; }
        .selection-card:hover { transform: translateY(-4px); box-shadow: 0 6px 16px rgba(0,0,0,0.12); }
        .selection-card h3 { font-family: 'Fredoka One', cursive; color: #4a5a94; font-size: 1.4em; margin-bottom: 12px; border-bottom: 2px solid #e2e8f0; padding-bottom: 8px; text-align: center; }
        .selection-card p, .selection-card li { font-size: 1em; color: #5a677a; margin-bottom: 6px; }
        .selection-card strong { color: #3d4a78; font-weight: 700; }
        .selection-card ul { list-style: none; padding: 0; }
        .selection-card .leaderboard-list, .selection-card .medals-list-container { margin-top: 10px; }

        #math-game-container, #simon-game-container, #mind-twist-game-v2-container, #number-memory-game-container { display: none; flex-direction: column; align-items: center; width: 100%; animation: zoomIn 0.4s ease-out; }
        .game-stats { display: flex; justify-content: space-around; align-items: center; width: 100%; margin-bottom: 18px; font-size: 1.05em; color: #718096; padding: 8px 12px; background-color: #f8f9fa; border-radius:10px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); }
        .player-name-display { font-weight: 700; color: #5A67D8; font-size:1.1em; }
        .lives-display, .timer-display { font-weight: 700; font-size:1.1em; color: #4A5568;}
        .lives-display span, .timer-display span { color: #DD6B20; }
        .timer-display.text-red-500 span { color: #E53E3E !important; animation: pulseRed 1s infinite; }

        /* Estilos Mates */
        #math-game-container .level-info { font-size: 1.15em; color: #4A5568; margin-bottom: 6px; font-weight: 600; }
        #math-game-container .progress-bar-container { width: 85%; max-width: 420px; height: 24px; background-color: #E2E8F0; border-radius: 12px; margin-bottom: 18px; overflow: hidden; border: 1px solid #CBD5E0; box-shadow: inset 0 1px 2px rgba(0,0,0,0.05); }
        #math-game-container .progress-bar { height: 100%; width: 0%; background: linear-gradient(to right, #68D391, #48BB78); border-radius: 11px; transition: width 0.5s ease-in-out; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.9em; font-weight: 600; text-shadow: 1px 1px 1px rgba(0,0,0,0.2); }
        #math-game-container .problem { font-size: 2.3em; margin-bottom: 22px; color: #2D3748; min-height: 1.6em; display: flex; justify-content: center; align-items: center; flex-wrap: wrap; padding: 12px 18px; background-color: #edf2f7; border-radius: 10px; box-shadow: inset 0 2px 5px rgba(0,0,0,0.07); font-family: 'Fredoka One', cursive; }
        #math-game-container .problem span { margin: 0 10px; }
        #math-game-container .input-area { margin-bottom: 22px; display: flex; justify-content: center; align-items: center; flex-wrap: wrap; }
        #math-game-container input[type="number"] { padding: 14px 18px; margin: 6px; border: 2px solid #CBD5E0; border-radius: 10px; font-size: 1.45em; width: 140px; text-align: center; box-sizing: border-box; transition: border-color 0.3s ease, box-shadow 0.3s ease; font-family: 'Nunito', sans-serif; }
        #math-game-container input[type="number"]:focus { border-color: #63B3ED; box-shadow: 0 0 0 4px rgba(99, 179, 237, 0.25); outline: none; }
        #math-game-container .input-area button { background-color: #4299E1; margin-left: 12px; }
        #math-game-container .input-area button:hover { background-color: #3582c0; }
        #math-game-container .result-area { margin-top: 18px; width: 100%; }
        #math-game-container .result { font-size: 1.25em; font-weight: 700; min-height: 1.6em; transition: transform 0.3s ease-out, background-color 0.3s ease, color 0.3s ease; padding: 12px 18px; border-radius: 10px; margin-bottom:12px; }
        #math-game-container .result.correct { color: #2F855A; background-color: #C6F6D5; transform: scale(1.03); border: 1px solid #9AE6B4;}
        #math-game-container .result.incorrect { color: #C53030; background-color: #FED7D7; animation: shake 0.5s; border: 1px solid #FEB2B2;}
        #math-game-container .result.level-up { color: #B7791F; background-color: #FEEBC8; transform: scale(1.08); animation: pulse 1s 1; border: 1px solid #FBD38D;}
        #math-game-container .result.level-down { color: #C53030; background-color: #FED7D7; animation: shake 0.8s; border: 1px solid #FEB2B2;}
        #math-game-container .explanation { font-size: 0.95em; color: #4A5568; margin-top: 8px; padding: 12px; background-color: #f7fafc; border: 1px solid #e2e8f0; border-radius: 10px; text-align: left; line-height: 1.55; max-height: 110px; overflow-y: auto; }
        #math-game-container .explanation strong { color: #2D3748; }
        #math-game-container .explanation code { background-color: #edf2f7; padding: 3px 6px; border-radius: 5px; font-family: monospace; color: #2b6cb0;}

        .back-to-selection-btn { background-color: #A0AEC0; margin-top: 25px; font-size: 1em; padding: 10px 18px; }
        .back-to-selection-btn:hover { background-color: #7f8c9b; }

        /* Estilos MindTwist V2 */
        #mind-twist-game-v2-container { background-color: #f7faff; padding: 20px; border-radius: 15px; box-shadow: 0 8px 16px rgba(0,0,0,0.1); width: 100%; max-width: 550px; }
        #mind-twist-game-v2-container .game-title { font-family: 'Fredoka One', cursive; color: #ED8936; font-size: 2em; margin-bottom: 15px; }
        #mind-twist-game-v2-container .riddle-text { font-size: 1.25em; color: #4A5568; margin-bottom: 20px; min-height: 2.5em; }
        #mind-twist-game-v2-container .options-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
        #mind-twist-game-v2-container .option-button { background-color: #4299E1; color: white; padding: 12px; border-radius: 10px; font-size: 1.3em; font-family: 'Nunito', sans-serif; border: none; cursor: pointer; transition: background-color 0.2s ease, transform 0.15s ease; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        #mind-twist-game-v2-container .option-button:hover { background-color: #3582c0; transform: translateY(-2px); }
        #mind-twist-game-v2-container .feedback-text { font-size: 1em; font-weight: 600; min-height: 1.5em; margin-bottom: 15px; }
        #mind-twist-game-v2-container .feedback-text.correct { color: #38A169; }
        #mind-twist-game-v2-container .feedback-text.incorrect { color: #E53E3E; }
        #mind-twist-game-v2-container .feedback-text.hint { color: #4299E1; }
        #mind-twist-game-v2-container .feedback-text.paused { color: #DD6B20; }
        #mind-twist-game-v2-container .controls-area { display: flex; justify-content: space-around; align-items: center; margin-top: 10px; flex-wrap: wrap; }
        #mind-twist-game-v2-container .control-button { font-size: 0.9em; padding: 10px 18px; }
        #mind-twist-game-v2-container #mt-v2-hint-btn { background-color: #4299E1; } #mind-twist-game-v2-container #mt-v2-hint-btn:hover { background-color: #3582c0; }
        #mind-twist-game-v2-container #mt-v2-pause-btn { background-color: #ED8936; } #mind-twist-game-v2-container #mt-v2-pause-btn:hover { background-color: #d57b2f; }
        #mind-twist-game-v2-container #mt-v2-next-btn { background-color: #38A169; display:none; } #mind-twist-game-v2-container #mt-v2-next-btn:hover { background-color: #2f855a; }

        /* Estilos Simon */
        #simon-game-container h2 { color: #38A169; margin-bottom: 10px; font-size: 2.1em; font-family: 'Fredoka One', cursive;}
        #simon-game-container .cognitive-concept { font-size: 1em; color: #5a677a; margin: 0 auto 15px auto; max-width: 80%; line-height: 1.5; }
        #simon-start-button { background-color: #38A169; margin-bottom: 20px; }
        #simon-start-button:hover { background-color: #2f855a; }
        #simon-pads-area { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; width: 220px; height: 220px; margin: 0 auto 20px auto; }
        .simon-pad { border-radius: 15px; cursor: pointer; transition: opacity 0.1s ease-in-out, transform 0.1s ease-in-out; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .simon-pad:hover:not(.active):not(:disabled) { transform: scale(1.03); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        .simon-pad:active:not(.active):not(:disabled) { transform: scale(0.97); }
        .simon-pad.red { background-color: #e74c3c; } .simon-pad.green { background-color: #2ecc71; }
        .simon-pad.blue { background-color: #3498db; } .simon-pad.yellow { background-color: #f1c40f; }
        .simon-pad.active { opacity: 0.6; transform: scale(0.95); box-shadow: inset 0 0 10px rgba(0,0,0,0.2); }
        .simon-pad:disabled { cursor: not-allowed; opacity: 0.7; }
        #simon-game-container .score-display { font-size: 1.3em; font-weight: 700; color: #4A5568; margin-bottom: 10px; }
        #simon-game-container .score-display strong { color: #38A169; }
        #simon-feedback { font-size: 1.1em; color: #5A67D8; font-weight: 600; min-height: 1.5em; margin-bottom: 15px; }


        /* --- ESTILOS PARA JUEGO MEMORIA DE N√öMEROS --- */
        #number-memory-game-container {
            background-color: #f7faff;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 600px;
        }
        #number-memory-game-container .nm-title {
            font-family: 'Fredoka One', cursive;
            color: #805AD5;
            font-size: 2em;
            margin-bottom: 8px;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        #number-memory-game-container .nm-subtitle {
            color: #5a677a;
            font-size: 1.1em;
            margin-bottom: 20px;
        }
        #number-memory-game-container .nm-game-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 12px;
            margin-bottom: 25px;
        }
        #number-memory-game-container .nm-info-card {
            background: #805AD5;
            color: white;
            padding: 12px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(128, 90, 213, 0.2);
        }
        #number-memory-game-container .nm-info-label { font-size: 0.85em; opacity: 0.9; margin-bottom: 4px; }
        #number-memory-game-container .nm-info-value { font-size: 1.4em; font-weight: bold; }

        #number-memory-game-container .nm-difficulty-selector { margin: 20px 0; }
        #number-memory-game-container .nm-difficulty-selector label { color: #4A5568; font-weight: 600; margin-right: 8px;}
        #number-memory-game-container .nm-difficulty-selector select {
            padding: 8px 12px;
            border: 2px solid #805AD5;
            border-radius: 8px;
            font-size: 1em;
            background: white;
            color: #805AD5;
            cursor: pointer;
            font-family: 'Nunito', sans-serif;
        }
        #number-memory-game-container .nm-sequence-display {
            font-size: 1.15em; color: #667eea; margin: 15px 0; font-weight: 600; min-height: 1.5em;
        }
        #number-memory-game-container .nm-game-message {
            margin: 15px 0; padding: 12px; border-radius: 8px; font-weight: 600; opacity: 0; transition: all 0.3s ease;
        }
        #number-memory-game-container .nm-game-message.show { opacity: 1; }
        #number-memory-game-container .nm-message-success { background-color: #C6F6D5; color: #2F855A; border: 1px solid #9AE6B4; }
        #number-memory-game-container .nm-message-info { background-color: #EBF4FF; color: #4299E1; border: 1px solid #BEE3F8; }
        #number-memory-game-container .nm-message-error { background-color: #FED7D7; color: #C53030; border: 1px solid #FEB2B2; }


        #number-memory-game-container .nm-game-board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 25px auto;
            max-width: 360px;
        }
        #number-memory-game-container .nm-number-card {
            aspect-ratio: 1;
            background: #667eea;
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 1.8em;
            font-weight: bold;
            font-family: 'Fredoka One', cursive;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.25);
            display: flex; align-items: center; justify-content: center;
        }
        #number-memory-game-container .nm-number-card:hover:not(:disabled) {
            transform: translateY(-2px);
            background-color: #5a67d8;
        }
        #number-memory-game-container .nm-number-card.flipped {
            background: #A3BFFA;
            color: #2D3748;
        }
        #number-memory-game-container .nm-number-card.matched {
            background: #68D391;
            transform: scale(1.05);
        }
        #number-memory-game-container .nm-number-card.hidden {
            background: #CBD5E0;
            color: transparent;
            /* pointer-events: none; No deshabilitar eventos aqu√≠ para que el click funcione luego */
        }
        #number-memory-game-container .nm-number-card:disabled {
             background: #E2E8F0; /* Un gris m√°s oscuro cuando est√° realmente deshabilitado */
             cursor: not-allowed;
             color: #A0AEC0;
        }

        #number-memory-game-container .nm-number-card.pulse-effect {
            animation: pulseBlue 0.6s ease-in-out;
            background-color: #4299e1 !important;
        }
        @keyframes pulseBlue { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        #number-memory-game-container .nm-controls { display: flex; gap: 15px; justify-content: center; margin-top: 20px; flex-wrap: wrap;}
        #number-memory-game-container .nm-btn-primary { background-color: #667eea; }
        #number-memory-game-container .nm-btn-success { background-color: #48BB78; }
        #number-memory-game-container .nm-btn-warning { background-color: #ED8936; }


        /* Loot Box, Leaderboard, Medals, Daily Bonus, Notifications, Animaciones (Se mantienen como est√°n) */
        /* ... (estilos sin cambios) ... */

        /* Estilos Responsivos */
        @media (max-width: 700px) {
            /* ... (ajustes generales responsivos) ... */
        }
         @media (max-width: 480px) {
            /* ... (ajustes generales responsivos m√°s peque√±os) ... */
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="welcome-screen" id="welcome-screen">
            <h1>üöÄ ¬°Desaf√≠os Mentales! üß†</h1>
            <p>Ingresa tus datos para la aventura:</p>
            <input type="text" id="player-name-input" placeholder="Tu Nombre de Campe√≥n" maxlength="20">
            <input type="password" id="player-password-input" placeholder="Contrase√±a (m√≠n. 4)" maxlength="20">
            <p id="auth-error-message" class="auth-error-message">Error aqu√≠</p>
            <button onclick="handleLoginOrCreate()">Acceder / Crear</button>
        </div>

        <div class="selection-screen" id="selection-screen">
            <h2>¬°Hola, <span id="display-player-name-selection"></span>!</h2>
            <p class="greeting-subtext">¬øListo para ejercitar tu mente? Elige tu desaf√≠o:</p>
            <button class="logout-button" onclick="logout()">Cerrar Sesi√≥n</button>
            <div class="game-selection-buttons">
                <button onclick="selectGame('math')">Mates R√°pidas üßÆ</button>
                <button onclick="selectGame('mindtwist_v2')" class="game-mindtwist">Acertijos Visuales ü§î</button>
                <button onclick="selectGame('simon')" class="game-simon">Secuencia de Colores üé®</button>
                <button onclick="selectGame('numberMemory')" class="game-number-memory">Memoria de N√∫meros üî¢</button>
                <button onclick="selectGame('memoryPairs')" class="upcoming">Parejas de Memoria üÉè (Pr√≥ximamente)</button>
                <button onclick="selectGame('slidingPuzzle')" class="upcoming">Laberinto Deslizante üß± (Pr√≥ximamente)</button>
            </div>
            <div class="selection-grid">
                <div class="selection-card" id="player-stats-card">
                    <h3>üìä Tus Estad√≠sticas</h3>
                    <div class="player-stats-summary">
                        <p>Mejor Racha (Mates): <strong id="summary-math-best-streak">0</strong></p>
                        <p>Acertijos V2 Resueltos: <strong id="summary-mindtwist-v2-solved">0</strong></p>
                        <p>Puntuaci√≥n M√°x. (Sim√≥n): <strong id="summary-simon-score">0</strong></p>
                        <p>Puntuaci√≥n M√°x. (Mem. N√∫m.): <strong id="summary-number-memory-score">0</strong></p>
                    </div>
                </div>
                <div class="selection-card" id="leaderboard-card">
                    <h3>üèÜ Tabla de Posiciones</h3>
                    <p style="font-size:0.85em; text-align:center; margin-bottom:8px;">(Mates / Sim√≥n / Mem. N√∫meros)</p>
                    <ul class="leaderboard-list" id="leaderboard-list"></ul>
                </div>
                <div class="selection-card" id="medals-card">
                    <h3>üéñÔ∏è Tus Medallas</h3>
                    <div class="medals-list-container">
                        <div class="medals-list" id="medals-list"></div>
                    </div>
                </div>
                 <div class="selection-card daily-bonus-card" id="daily-bonus-card-container" style="display:none;"> <h3>üéÅ Bonificaci√≥n Diaria</h3>
                    <div class="daily-bonus-container" id="daily-bonus-container">
                        <h4>üéâ ¬°Recompensa Especial! üéâ</h4>
                        <p id="daily-bonus-message"></p>
                        <button onclick="collectDailyBonus()">¬°Reclamar!</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="math-game-container">
            <!-- ... (HTML de Mates R√°pidas) ... -->
             <div class="game-stats">
                <div class="player-name-display">Jugador: <span id="math-display-player-name"></span></div>
                <div class="lives-display">‚ù§Ô∏è Vidas: <span id="math-player-lives">3</span></div>
                <div class="timer-display" id="math-timer-wrapper">‚è±Ô∏è Tiempo: <span id="math-time-left">0</span>s</div>
            </div>
            <div class="level-info">Nivel: <span id="math-current-level">1</span></div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="math-progress-bar-fill">0%</div>
            </div>
            <div class="level-info">Racha Actual: <span id="math-correct-streak">0</span>/<span id="math-correct-per-level-display">5</span></div>
            <div class="level-info">Mejor Racha: <span id="math-best-streak">0</span></div>
            <div class="problem" id="math-problem"></div>
            <div class="input-area">
                <input type="number" id="math-user-answer" placeholder="Tu Respuesta" inputmode="numeric">
                <button onclick="checkMathAnswer()">Verificar ‚ú®</button>
            </div>
            <div class="result-area">
                <div class="result" id="math-game-result"></div>
                <div class="explanation" id="math-answer-explanation" style="display: none;"></div>
            </div>
            <button class="back-to-selection-btn" onclick="showScreen('selection')">‚Ü©Ô∏è Volver a Elegir Juego</button>
        </div>

        <div id="mind-twist-game-v2-container">
            <!-- ... (HTML de Acertijos Visuales V2) ... -->
            <div class="game-stats">
                <div class="player-name-display">Jugador: <span id="mindtwist-v2-display-player-name"></span></div>
                <div class="timer-display" id="mindtwist-v2-timer-wrapper">‚è±Ô∏è Tiempo: <span id="mindtwist-v2-time-left">0</span>s</div>
            </div>
            <div class="game-title">Mind Twist - Nivel <span id="mt-v2-level-number">1</span></div>
            <div id="mt-v2-riddle" class="riddle-text">Cargando acertijo...</div>
            <div id="mt-v2-options" class="options-grid"></div>
            <div id="mt-v2-feedback" class="feedback-text"></div>
            <div class="controls-area">
                <button id="mt-v2-hint-btn" class="control-button">Pista</button>
                <button id="mt-v2-pause-btn" class="control-button">Pausar</button>
                <button id="mt-v2-next-btn" class="control-button">Siguiente</button>
            </div>
            <button class="back-to-selection-btn button-style" onclick="showScreen('selection')">‚Ü©Ô∏è Volver</button>
        </div>

        <div id="simon-game-container">
            <!-- ... (HTML de Sim√≥n) ... -->
            <h2>Secuencia de Colores</h2>
            <p class="cognitive-concept">Concepto Cognitivo: Memoria de trabajo, atenci√≥n y control inhibitorio. Este juego desaf√≠a tu capacidad para recordar y reproducir secuencias visuales.</p>
            <button id="simon-start-button" onclick="startSimonGame()">Empezar Juego</button>
            <div id="simon-pads-area">
                <div class="simon-pad red" data-color="red" id="simon-pad-red"></div>
                <div class="simon-pad green" data-color="green" id="simon-pad-green"></div>
                <div class="simon-pad blue" data-color="blue" id="simon-pad-blue"></div>
                <div class="simon-pad yellow" data-color="yellow" id="simon-pad-yellow"></div>
            </div>
            <p class="score-display">Puntuaci√≥n: <strong id="simon-score">0</strong></p>
            <p id="simon-feedback">¬°Presiona "Empezar Juego"!</p>
            <button class="back-to-selection-btn" onclick="showScreen('selection')">‚Ü©Ô∏è Volver a Elegir Juego</button>
        </div>

        <div id="number-memory-game-container">
            <h2 class="nm-title">
                <span style="font-size: 1em;">üß†</span>
                Memoria de N√∫meros
                <span style="font-size: 1em;">üî¢</span>
            </h2>
            <p class="nm-subtitle">¬°Memoriza la secuencia y rep√≠tela!</p>
            <div class="nm-game-info">
                <div class="nm-info-card">
                    <div class="nm-info-label">Nivel</div>
                    <div class="nm-info-value" id="nm-level">1</div>
                </div>
                <div class="nm-info-card">
                    <div class="nm-info-label">Puntuaci√≥n</div>
                    <div class="nm-info-value" id="nm-score">0</div>
                </div>
                <div class="nm-info-card">
                    <div class="nm-info-label">Mejor Puntuaci√≥n</div>
                    <div class="nm-info-value" id="nm-bestScore">0</div>
                </div>
            </div>
            <div class="nm-difficulty-selector">
                <label for="nm-difficulty">Dificultad: </label>
                <select id="nm-difficulty">
                    <option value="easy">F√°cil</option>
                    <option value="medium" selected>Medio</option>
                    <option value="hard">Dif√≠cil</option>
                    <option value="expert">Experto</option>
                </select>
            </div>
            <div class="nm-sequence-display" id="nm-sequenceDisplay"></div>
            <div class="nm-game-message" id="nm-gameMessage"></div>
            <div class="nm-game-board" id="nm-gameBoard">
                <!-- Las tarjetas se generan aqu√≠ por JS -->
            </div>
            <div class="nm-controls">
                <button class="button-style nm-btn nm-btn-primary" id="nm-startBtn">Comenzar</button>
                <button class="button-style nm-btn nm-btn-success" id="nm-showSequenceBtn" style="display: none;">Ver Secuencia</button>
                <button class="button-style nm-btn nm-btn-warning" id="nm-resetBtn">Reiniciar</button>
            </div>
            <button class="back-to-selection-btn button-style" onclick="showScreen('selection')">‚Ü©Ô∏è Volver</button>
        </div>


        <div class="loot-box-container" id="loot-box-modal">
            <h3>¬°Caja de Recompensas!</h3>
            <div class="loot-box-icon">üéÅ</div>
            <p class="loot-box-reward" id="loot-box-reward-text">Abriendo...</p>
            <button onclick="closeLootBox()">¬°Genial!</button>
        </div>
        <div class="notification" id="notification-display"></div>
    </div>

    <script>
        // --- DOM Elements ---
        const welcomeScreen = document.getElementById('welcome-screen');
        const selectionScreen = document.getElementById('selection-screen');
        const mathGameContainer = document.getElementById('math-game-container');
        const mindTwistGameV2Container = document.getElementById('mind-twist-game-v2-container');
        const simonGameContainer = document.getElementById('simon-game-container');
        const numberMemoryGameContainer = document.getElementById('number-memory-game-container');

        const playerNameInput = document.getElementById('player-name-input');
        const playerPasswordInput = document.getElementById('player-password-input');
        const authErrorMessage = document.getElementById('auth-error-message');
        const displayPlayerNameSelection = document.getElementById('display-player-name-selection');

        // Math Elements
        const mathDisplayPlayerName = document.getElementById('math-display-player-name');
        const mathPlayerLivesDisplay = document.getElementById('math-player-lives');
        const mathTimeLeftDisplay = document.getElementById('math-time-left');
        const mathTimerWrapper = document.getElementById('math-timer-wrapper');
        const mathCurrentLevelDisplay = document.getElementById('math-current-level');
        const mathProgressBarFill = document.getElementById('math-progress-bar-fill');
        const mathCorrectStreakDisplay = document.getElementById('math-correct-streak');
        const mathCorrectPerLevelDisplay = document.getElementById('math-correct-per-level-display');
        const mathBestStreakDisplay = document.getElementById('math-best-streak');
        const mathProblemDisplay = document.getElementById('math-problem');
        const mathUserAnswerInput = document.getElementById('math-user-answer');
        const mathGameResultDisplay = document.getElementById('math-game-result');
        const mathAnswerExplanationDisplay = document.getElementById('math-answer-explanation');

        // Mind Twist V2 Elements
        const mindtwistV2DisplayPlayerName = document.getElementById('mindtwist-v2-display-player-name');
        const mindtwistV2TimeLeftDisplay = document.getElementById('mindtwist-v2-time-left');
        const mindtwistV2TimerWrapper = document.getElementById('mindtwist-v2-timer-wrapper');
        const mtV2LevelNumber = document.getElementById("mt-v2-level-number");
        const mtV2RiddleText = document.getElementById("mt-v2-riddle");
        const mtV2OptionsContainer = document.getElementById("mt-v2-options");
        const mtV2Feedback = document.getElementById("mt-v2-feedback");
        const mtV2HintBtn = document.getElementById("mt-v2-hint-btn");
        const mtV2PauseBtn = document.getElementById("mt-v2-pause-btn");
        const mtV2NextBtn = document.getElementById("mt-v2-next-btn");

        // Simon Elements
        const simonStartButton = document.getElementById('simon-start-button');
        const simonPadElements = {
            red: document.getElementById('simon-pad-red'), green: document.getElementById('simon-pad-green'),
            blue: document.getElementById('simon-pad-blue'), yellow: document.getElementById('simon-pad-yellow')
        };
        const simonScoreDisplay = document.getElementById('simon-score');
        const simonFeedbackDisplay = document.getElementById('simon-feedback');

        // Number Memory Elements
        let nmGameInstance = null;
        const nmLevelDisplayElem = document.getElementById('nm-level'); // Renombrado para evitar colisi√≥n
        const nmScoreDisplayElem = document.getElementById('nm-score');
        const nmBestScoreDisplayElem = document.getElementById('nm-bestScore');
        const nmStartBtn = document.getElementById('nm-startBtn');
        const nmShowSequenceBtn = document.getElementById('nm-showSequenceBtn');
        const nmResetBtn = document.getElementById('nm-resetBtn');
        const nmGameMessageElem = document.getElementById('nm-gameMessage');
        const nmDifficultySelect = document.getElementById('nm-difficulty');
        const nmSequenceDisplayElem = document.getElementById('nm-sequenceDisplay');
        const nmGameBoardElem = document.getElementById('nm-gameBoard');

        // Summary Stats Elements
        const summaryMathBestStreak = document.getElementById('summary-math-best-streak');
        const summaryMindtwistV2Solved = document.getElementById('summary-mindtwist-v2-solved');
        const summarySimonScore = document.getElementById('summary-simon-score');
        const summaryNumberMemoryScore = document.getElementById('summary-number-memory-score');

        // UI Global Elements
        const lootBoxModal = document.getElementById('loot-box-modal');
        const lootBoxRewardText = document.getElementById('loot-box-reward-text');
        const notificationDisplay = document.getElementById('notification-display');
        const leaderboardList = document.getElementById('leaderboard-list');
        const medalsList = document.getElementById('medals-list');
        const dailyBonusContainer = document.getElementById('daily-bonus-container');
        const dailyBonusCardContainer = document.getElementById('daily-bonus-card-container');
        const dailyBonusMessage = document.getElementById('daily-bonus-message');

        // --- Game State & Config ---
        let currentLoggedInPlayer = null;
        let allUsersData = {};
        const defaultPlayerStats = () => ({
            math: { currentLevel: 1, correctStreak: 0, bestStreak: 0, playerLives: 3, totalCorrect: 0, totalIncorrect: 0, totalGamesPlayed: 0, questionsInLevel: 0 },
            mindtwistV2: { currentLevel: 0, highestLevelReached: 0, hintsUsed: 0, solvedCount: 0, totalAttempts: 0 },
            simon: { highestScore: 0, longestSequence: 0, totalGamesPlayed: 0 },
            numberMemory: { highestScore: 0, highestLevelReached: 0, gamesPlayed: 0, currentDifficulty: 'medium', maxLevel: 20 },
            inventory: [], medals: [], lastPlayed: null, dailyBonusDay: 0, lastLoginDate: null,
            loginHistory: []
        });

        let activeGame = null;
        // Math
        const MATH_CORRECT_PER_LEVEL = 5; const MATH_MAX_LEVEL = 20; const INITIAL_LIVES = 3;
        let mathCorrectAnswer; let mathTimerId = null; let mathTimeLeft = 0;
        const MATH_BASE_TIME_PER_QUESTION = 15; const MATH_TIME_REDUCTION_PER_LEVEL = 0.5; const MATH_MIN_TIME_PER_QUESTION = 5;
        // MindTwist V2
        let mtV2_paused = false; let mtV2_timerId = null; let mtV2_timeLeft = 0;
        const MT_V2_BASE_TIME_PER_LEVEL = 30; const MT_V2_TIME_INCREMENT_CORRECT = 5;
        const mindTwistV2Levels = [ /* ... (niveles como antes) ... */ { riddle: "¬øCu√°l figura no encaja?", options: ["‚¨õ", "‚¨õ", "‚¨õ", "‚¨ú"], answer: 3, hint: "Una de las figuras tiene un color diferente." }, { riddle: "¬øCu√°l n√∫mero sigue? 2, 4, 8, 16, ?", options: ["18", "32", "24", "20"], answer: 1, hint: "Piensa en multiplicaciones por 2." }, { riddle: "¬øQu√© letra falta? A, C, E, G, ?", options: ["I", "H", "J", "K"], answer: 0, hint: "Cada letra salta una del abecedario." }, { riddle: "¬øQu√© figura es sim√©trica verticalmente?", options: ["‚¨õ", "üî∫", "üîµ", "üîª"], answer: 2, hint: "Piensa en reflejo de espejo vertical." }, { riddle: "¬øQu√© objeto pesa m√°s?", options: ["Pluma", "Ladrillo", "Papel", "Algod√≥n"], answer: 1, hint: "Compara materiales." }, { riddle: "¬øQu√© sombra corresponde al objeto? ‚òÇÔ∏è", options: ["üåÇ", "‚òÇÔ∏è", "ü™É", "ü™Å"], answer: 1, hint: "Busca la forma exacta." }, { riddle: "¬øQu√© imagen no tiene simetr√≠a?", options: ["üîµ", "üî∫", "üåÄ", "‚ö°"], answer: 3, hint: "Observa si puedes dividirla en mitades iguales." }, { riddle: "¬øCu√°l figura rota 90¬∞ sigue? ‚¨ÜÔ∏è ‚û°Ô∏è ‚¨áÔ∏è ?", options: ["‚¨ÖÔ∏è", "‚¨ÜÔ∏è", "‚û°Ô∏è", "‚è´"], answer: 0, hint: "Rotaci√≥n en sentido horario." }, { riddle: "¬øQu√© n√∫mero falta? 1, 3, 6, 10, ?", options: ["12", "14", "15", "16"], answer: 2, hint: "Suma consecutiva: +2, +3, +4..." }, { riddle: "¬øCu√°l figura es diferente por cantidad de lados?", options: ["üü•", "üî∫", "üîµ", "üü®"], answer: 2, hint: "Piensa en lados y curvas." } ];
        // Simon
        let simonGameActive = false; let simonSequence = []; let simonPlayerSequence = []; let simonCurrentScore = 0; let simonTurn = 'computer';
        const SIMON_COLORS = ['red', 'green', 'blue', 'yellow']; const SIMON_FLASH_DURATION = 300; const SIMON_INTER_FLASH_DELAY = 250; const SIMON_ROUND_DELAY = 1000;

        // Loot Box & Medals
        const MATH_GAME_LOOT_BOX_PROBABILITY = 0.25; const MINDTWIST_V2_LOOT_BOX_PROBABILITY = 0.20; const SIMON_LOOT_BOX_PROBABILITY = 0.20; const NUMBER_MEMORY_LOOT_BOX_PROBABILITY = 0.18;
        const MEDALS = [ /* ... (Medallas como antes, incluyendo las de numberMemory) ... */  { id: "first_game", name: "Primer Juego", description: "Juega tu primera partida de cualquier juego.", icon: "üéÆ", condition: (stats) => stats.math.totalGamesPlayed > 0 || stats.mindtwistV2.totalAttempts > 0 || stats.simon.totalGamesPlayed > 0 || stats.numberMemory.gamesPlayed > 0}, { id: "math_first_correct", name: "Matiniciante", description: "Resuelve tu primer problema de Mates R√°pidas.", icon: "‚ûï", condition: (stats) => stats.math.totalCorrect > 0 && stats.math.totalGamesPlayed > 0 }, { id: "mindtwist_v2_first_try", name: "Explorador V2", description: "Intenta resolver tu primer acertijo visual V2.", icon: "üßê", condition: (stats) => stats.mindtwistV2.totalAttempts > 0 }, { id: "mindtwist_v2_solved_1", name: "Acertijo V2 Resuelto", description: "Resuelve tu primer acertijo visual V2.", icon: "üí°", condition: (stats) => stats.mindtwistV2.solvedCount >= 1 }, { id: "simon_first_game", name: "Maestro Sim√≥n Jr.", description: "Juega tu primera partida de Secuencia de Colores.", icon: "üé®", condition: (stats) => stats.simon.totalGamesPlayed > 0}, { id: "nm_first_game", name: "Numer√≥logo Inicial", description: "Juega tu primera partida de Memoria de N√∫meros.", icon: "üíØ", condition: (stats) => stats.numberMemory.gamesPlayed > 0}, { id: "nm_score_100", name: "Cien Puntos Num√©ricos", description: "Alcanza 100 puntos en Memoria de N√∫meros.", icon: "üìà", condition: (stats) => stats.numberMemory.highestScore >= 100}, { id: "math_streak_5", name: "Racha de 5 (Mates)", description: "Logra una racha de 5 respuestas correctas en Mates R√°pidas.", icon: "üèÖ", condition: (stats) => stats.math.bestStreak >= 5 }, { id: "math_level_5", name: "Nivel 5 (Mates)", description: "Alcanza el nivel 5 en Mates R√°pidas.", icon: "üèÜ", condition: (stats) => stats.math.currentLevel >= 5 }, { id: "math_level_10", name: "Nivel 10 (Mates)", description: "Alcanza el nivel 10 en Mates R√°pidas.", icon: "üåü", condition: (stats) => stats.math.currentLevel >= 10 }, { id: "simon_score_50", name: "Sim√≥n Puntuador", description: "Alcanza 50 puntos en Secuencia de Colores.", icon: "üéØ", condition: (stats) => stats.simon.highestScore >= 50}, { id: "simon_sequence_5", name: "Memoria Prodigiosa", description: "Repite una secuencia de 5 colores en Sim√≥n.", icon: "üß†", condition: (stats) => stats.simon.longestSequence >= 5}, { id: "daily_login_3", name: "Visitante Frecuente", description: "Inicia sesi√≥n 3 d√≠as diferentes.", icon: "üìÖ", condition: (stats) => countUniqueLoginDays(stats) >= 3 } ];

        let mathCurrentProblemDetails = {};
        // --- Audio ---
        let synthsInitialized = false;
        let correctSound, incorrectSound, levelUpSound, gameStartSound, levelDownSound, lifeLostSound, mindTwistV2CorrectSound, mindTwistV2IncorrectSound, lootBoxSound, dailyBonusSound, medalSound, clickSound, timerTickSound, simonPadSounds = {}, nmCardClickSound, nmSequenceHighlightSound, nmErrorSound;

        async function initializeAudio() { if (synthsInitialized || (Tone.context && Tone.context.state === 'running')) return; try { await Tone.start(); console.log("AudioContext started successfully!"); correctSound = new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.05, release: 0.2 } }).toDestination(); incorrectSound = new Tone.Synth({ oscillator: { type: "square" }, envelope: { attack: 0.02, decay: 0.2, sustain: 0, release: 0.2 }, volume: -10 }).toDestination(); levelUpSound = new Tone.PolySynth(Tone.Synth, { oscillator: { type: "sawtooth" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.3, release: 0.5 }, volume: -5 }).toDestination(); gameStartSound = new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.05, decay: 0.3, sustain: 0.1, release: 0.5 }, volume: -8 }).toDestination(); levelDownSound = new Tone.NoiseSynth({ noise: { type: 'brown' }, envelope: { attack: 0.05, decay: 0.3, sustain: 0.1, release: 0.3 }, volume: -10 }).toDestination(); lifeLostSound = new Tone.Synth({ oscillator: { type: "sawtooth" }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.05, release: 0.1 }, volume: -12 }).toDestination(); mindTwistV2CorrectSound = new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.05, release: 0.2 }, volume: -15 }).toDestination(); mindTwistV2IncorrectSound = new Tone.Synth({ oscillator: { type: "square" }, envelope: { attack: 0.02, decay: 0.2, sustain: 0, release: 0.2 }, volume: -18 }).toDestination(); lootBoxSound = new Tone.PolySynth(Tone.Synth, { oscillator: { type: "triangle" }, envelope: { attack: 0.05, decay: 0.4, sustain: 0.1, release: 0.5 }, volume: -7 }).toDestination(); dailyBonusSound = new Tone.PolySynth(Tone.Synth, { oscillator: { type: "sine" }, envelope: { attack: 0.05, decay: 0.3, sustain: 0.1, release: 0.5 }, volume: -6 }).toDestination(); medalSound = new Tone.PolySynth(Tone.Synth, { oscillator: { type: "square" }, envelope: { attack: 0.02, decay: 0.3, sustain: 0.1, release: 0.4 }, volume: -8 }).toDestination(); clickSound = new Tone.MembraneSynth({ pitchDecay: 0.008, octaves: 2, envelope: { attack: 0.0006, decay: 0.2, sustain: 0 } }).toDestination(); timerTickSound = new Tone.MembraneSynth({ pitchDecay: 0.01, octaves: 1.5, envelope: { attack: 0.001, decay: 0.1, sustain: 0 }, volume: -25 }).toDestination(); simonPadSounds.red = new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.01, release: 0.1 }, volume: -12 }).toDestination(); simonPadSounds.green = new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.01, release: 0.1 }, volume: -12 }).toDestination(); simonPadSounds.blue = new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.01, release: 0.1 }, volume: -12 }).toDestination(); simonPadSounds.yellow = new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.01, release: 0.1 }, volume: -12 }).toDestination();
            nmCardClickSound = new Tone.Synth({ oscillator: {type: "triangle"}, envelope: {attack: 0.005, decay: 0.05, sustain: 0.01, release: 0.1}, volume: -18}).toDestination();
            nmSequenceHighlightSound = new Tone.Synth({oscillator: {type: "sine"}, envelope: {attack: 0.01, decay:0.1, sustain:0.02, release: 0.1}, volume: -15}).toDestination();
            nmErrorSound = new Tone.Synth({ oscillator: { type: "sawtooth" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.1 }, volume: -15 }).toDestination();
            synthsInitialized = true; } catch (e) { console.error("Error initializing AudioContext or synths:", e); }
        }
        const congratulations = [ /* ... */ "¬°Bien hecho, {name}! üéâ ¬°Nivel {level} desbloqueado!", "¬°Excelente trabajo! üåü ¬°Pasaste al Nivel {level}!", "¬°Fant√°stico, {name}! üöÄ ¬°Ya est√°s en el Nivel {level}!", "¬°Incre√≠ble! ‚ú® ¬°El Nivel {level} te espera, {name}!", "¬°Sigue as√≠, {name}! üî• ¬°Nivel {level} superado con √©xito!", "¬°Eres una estrella, {name}! üå† ¬°Bienvenido al Nivel {level}!", "¬°Lo lograste, {name}! üí™ ¬°A conquistar el Nivel {level}!" ];

        // --- Core & Utility Functions ---
        function getUserStats() { return currentLoggedInPlayer ? allUsersData[currentLoggedInPlayer].stats : null; }
        function countUniqueLoginDays(stats) { if (!stats || !stats.loginHistory) return 0; const uniqueDays = new Set(stats.loginHistory); return uniqueDays.size; }
        function playSound(sound, note, duration = '8n', timeOffset = '+0') { if (synthsInitialized && sound) { try { if (sound instanceof Tone.PolySynth) { sound.triggerAttackRelease(note, duration, Tone.now() + parseFloat(timeOffset.replace('+', ''))); } else if (sound instanceof Tone.NoiseSynth || sound instanceof Tone.MembraneSynth) { sound.triggerAttackRelease(duration, Tone.now() + parseFloat(timeOffset.replace('+', ''))); } else { sound.triggerAttackRelease(note, duration, Tone.now() + parseFloat(timeOffset.replace('+', ''))); } } catch (e) { console.error("Error playing sound:", e); } } }
        function playClickSound() { if(synthsInitialized && clickSound) playSound(clickSound, null, '16n'); }

        function showScreen(screenId) {
            playClickSound();
            ['welcome', 'selection', 'math', 'mind-twist-game-v2-container', 'simon', 'number-memory-game-container'].forEach(id => {
                const el = document.getElementById(id.endsWith('-container') ? id : (id + '-screen')) || document.getElementById(id + '-game-container');
                if (el) el.style.display = 'none';
            });
            clearTimeout(mathTimerId); clearTimeout(mtV2_timerId);
            if (simonGameActive) { simonGameActive = false; simonStartButton.disabled = false; Object.values(simonPadElements).forEach(pad => pad.disabled = true); }
            if (nmGameInstance && nmGameInstance.gameActive && activeGame === 'numberMemory') { // Solo pausar si se sale de este juego espec√≠fico
                 nmGameInstance.pauseGameForScreenChange?.();
            }

            let targetScreen;
            if (screenId === 'welcome') { targetScreen = welcomeScreen; playerNameInput.value = ''; playerPasswordInput.value = ''; authErrorMessage.style.display = 'none';
            } else if (screenId === 'selection') { if (!currentLoggedInPlayer) { showScreen('welcome'); return; } updateSelectionScreenStats(); checkDailyBonus(); updateMedalsDisplay(); updateLeaderboardDisplay(); targetScreen = selectionScreen;
            } else if (screenId === 'math') targetScreen = mathGameContainer;
            else if (screenId === 'mindtwist_v2') targetScreen = mindTwistGameV2Container;
            else if (screenId === 'simon') targetScreen = simonGameContainer;
            else if (screenId === 'numberMemory') targetScreen = numberMemoryGameContainer;
            if(targetScreen) targetScreen.style.display = 'flex';
            activeGame = screenId; // Actualizar juego activo despu√©s de cambiar
        }

        // --- Auth & User ---
        function handleLoginOrCreate() { /* ... (sin cambios) ... */  initializeAudio(); playClickSound(); const username = playerNameInput.value.trim(); const password = playerPasswordInput.value; authErrorMessage.style.display = 'none'; if (!username) { authErrorMessage.textContent = '¬°Tu nombre es esencial!'; authErrorMessage.style.display = 'block'; return; } if (username.length > 20) { authErrorMessage.textContent = 'Nombre demasiado largo (M√°x. 20).'; authErrorMessage.style.display = 'block'; return; } if (!password) { authErrorMessage.textContent = 'Contrase√±a requerida.'; authErrorMessage.style.display = 'block'; return; } if (password.length < 4) { authErrorMessage.textContent = 'Contrase√±a muy corta (M√≠n. 4).'; authErrorMessage.style.display = 'block'; return; }
            if (allUsersData[username]) { if (allUsersData[username].password === password) { currentLoggedInPlayer = username; showNotification(`¬°Bienvenido de nuevo, ${username}!`, 'success'); } else { authErrorMessage.textContent = 'Contrase√±a incorrecta.'; authErrorMessage.style.display = 'block'; return; }
            } else { allUsersData[username] = { password: password, stats: defaultPlayerStats(), }; currentLoggedInPlayer = username; showNotification(`¬°Cuenta creada para ${username}! ¬°Bienvenido!`, 'success'); }
            displayPlayerNameSelection.textContent = currentLoggedInPlayer; mathDisplayPlayerName.textContent = currentLoggedInPlayer; mindtwistV2DisplayPlayerName.textContent = currentLoggedInPlayer;
            const today = new Date().toISOString().split('T')[0]; const userStats = getUserStats(); if (!userStats.lastLoginDate || userStats.lastLoginDate !== today) { userStats.lastLoginDate = today; if (!userStats.loginHistory.includes(today)) { userStats.loginHistory.push(today); if (userStats.loginHistory.length > 30) userStats.loginHistory.shift(); } }
            saveAllUsersData(); showScreen('selection'); checkAndAwardMedal("first_game"); }
        function logout() { /* ... (sin cambios) ... */ playClickSound(); if (currentLoggedInPlayer) { showNotification(`¬°Hasta pronto, ${currentLoggedInPlayer}!`, 'event'); saveAllUsersData(); currentLoggedInPlayer = null; } showScreen('welcome'); }

        // --- Game Selection ---
        function selectGame(gameType) {
            playClickSound();
            if (!currentLoggedInPlayer) { showScreen('welcome'); return; }
            // No setear activeGame aqu√≠, sino en showScreen
            if (gameType === 'math') { startMathGame(); showScreen('math'); }
            else if (gameType === 'mindtwist_v2') { startMindTwistGameV2(); showScreen('mindtwist_v2'); }
            else if (gameType === 'simon') { startSimonGame(); showScreen('simon'); }
            else if (gameType === 'numberMemory') { startNumberMemoryGame(); showScreen('numberMemory');}
            else if (gameType === 'memoryPairs') { showNotification("Parejas de Memoria - ¬°Pr√≥ximamente!", "event"); /* No cambiar de pantalla */ }
            else if (gameType === 'slidingPuzzle') { showNotification("Laberinto Deslizante - ¬°Pr√≥ximamente!", "event"); /* No cambiar de pantalla */ }
        }

        // --- UI Updates ---
        function updateSelectionScreenStats() { const userStats = getUserStats(); if (!userStats) return; summaryMathBestStreak.textContent = userStats.math.bestStreak; summaryMindtwistV2Solved.textContent = userStats.mindtwistV2.solvedCount; summarySimonScore.textContent = userStats.simon.highestScore; summaryNumberMemoryScore.textContent = userStats.numberMemory.highestScore; }

        // --- Math Game Logic (sin cambios) ---
        function startMathGame() { /* ... */ const userStats = getUserStats(); if (!userStats) return; playSound(gameStartSound, 'C4', '0.5s'); userStats.math.currentLevel = userStats.math.currentLevel > 0 ? userStats.math.currentLevel : 1; userStats.math.playerLives = INITIAL_LIVES; userStats.math.correctStreak = 0; userStats.math.questionsInLevel = 0; const rachaBonusIndex = userStats.inventory.indexOf("bonus_racha_mates"); if (rachaBonusIndex > -1) { userStats.math.correctStreak = 1; userStats.inventory.splice(rachaBonusIndex, 1); showNotification("¬°Bonus de racha inicial aplicado!", "event", 2000); } updateMathGameDisplay(); nextMathProblem(); userStats.math.totalGamesPlayed++; saveAllUsersData(); checkAndAwardMedal("first_game"); }
        function getMathTimeForCurrentLevel() { /* ... */ const userStats = getUserStats(); let time = MATH_BASE_TIME_PER_QUESTION - (userStats.math.currentLevel -1) * MATH_TIME_REDUCTION_PER_LEVEL; time = Math.max(time, MATH_MIN_TIME_PER_QUESTION); if (userStats.math.questionsInLevel === 0) { const tiempoBonusIndex = userStats.inventory.indexOf("bonus_tiempo_inicio_mates"); if (tiempoBonusIndex > -1) { time += 5; userStats.inventory.splice(tiempoBonusIndex, 1); showNotification("¬°+5s de bonus de tiempo inicial!", "event", 2000); } } return time; }
        function nextMathProblem() { /* ... */ const userStats = getUserStats(); if (userStats.math.playerLives <= 0) { gameOverMath(); return; } clearTimeout(mathTimerId); mathTimeLeft = getMathTimeForCurrentLevel(); mathUserAnswerInput.value = ''; mathUserAnswerInput.focus(); mathAnswerExplanationDisplay.style.display = 'none'; mathGameResultDisplay.textContent = ''; mathGameResultDisplay.className = 'result'; mathTimerWrapper.classList.remove('text-red-500'); generateMathProblem(); updateMathGameDisplay(); mathTimerId = setInterval(updateMathTimer, 1000); }
        function generateMathProblem() { /* ... */ const userStats = getUserStats(); const level = userStats.math.currentLevel; let num1, num2, operator, problemText; if (level <= 3) { operator = Math.random() < 0.5 ? '+' : '-'; num1 = Math.floor(Math.random() * 10) + 1; num2 = Math.floor(Math.random() * 10) + 1; if (operator === '-' && num1 < num2) [num1, num2] = [num2, num1]; } else if (level <= 7) { const r = Math.random(); operator = r < 0.4 ? '+' : (r < 0.8 ? '-' : '*'); if (operator === '*') { num1 = Math.floor(Math.random() * 9) + 2; num2 = Math.floor(Math.random() * 9) + 2; } else { num1 = Math.floor(Math.random() * 20 * (level/3)) + 1; num2 = Math.floor(Math.random() * 20 * (level/3)) + 1; if (operator === '-' && num1 < num2) [num1, num2] = [num2, num1]; } } else if (level <= 12) { const r = Math.random(); operator = r < 0.3 ? '+' : (r < 0.5 ? '-' : (r < 0.85 ? '*' : '/')); if (operator === '*') { num1 = Math.floor(Math.random() * 10) + 5; num2 = Math.floor(Math.random() * 10) + (level > 9 ? 5 : 2); } else if (operator === '/') { num2 = Math.floor(Math.random() * 8) + 2; mathCorrectAnswer = Math.floor(Math.random() * 8) + 2; num1 = num2 * mathCorrectAnswer; } else { num1 = Math.floor(Math.random() * 50 * (level/6)) + 10; num2 = Math.floor(Math.random() * 50 * (level/6)) + 10; if (operator === '-' && num1 < num2) [num1, num2] = [num2, num1]; } } else { const r = Math.random(); operator = r < 0.4 ? '*' : (r < 0.7 ? '/' : '+'); if (operator === '*') { num1 = Math.floor(Math.random() * 15) + 5; num2 = Math.floor(Math.random() * 15) + 5; } else if (operator === '/') { num2 = Math.floor(Math.random() * 10) + 2; mathCorrectAnswer = Math.floor(Math.random() * 12) + 2; num1 = num2 * mathCorrectAnswer; } else { num1 = Math.floor(Math.random() * (50 + level * 5)) + 20; num2 = Math.floor(Math.random() * (50 + level * 5)) + 20; if (operator === '-' && num1 < num2) [num1, num2] = [num2, num1]; } } if (operator !== '/') { switch (operator) { case '+': mathCorrectAnswer = num1 + num2; break; case '-': mathCorrectAnswer = num1 - num2; break; case '*': mathCorrectAnswer = num1 * num2; break; } } mathCurrentProblemDetails = {num1, num2, operator}; problemText = `<span>${num1}</span> <span style="color: #667eea;">${operator}</span> <span>${num2}</span> = ?`; mathProblemDisplay.innerHTML = problemText; }
        function checkMathAnswer() { /* ... */ const userStats = getUserStats(); clearTimeout(mathTimerId); const userAnswer = parseInt(mathUserAnswerInput.value); if (isNaN(userAnswer)) { showMathResult("¬°Ingresa un n√∫mero!", "incorrect"); userStats.math.playerLives--; playSound(lifeLostSound, 'C3', '0.1s'); setTimeout(nextMathProblem, 1500); return; } if (userAnswer === mathCorrectAnswer) { userStats.math.correctStreak++; userStats.math.questionsInLevel++; userStats.math.totalCorrect++; if (userStats.math.correctStreak > userStats.math.bestStreak) { userStats.math.bestStreak = userStats.math.correctStreak; showNotification(`¬°Nueva mejor racha: ${userStats.math.bestStreak}!`, "streak", 2500); addToLeaderboard(currentLoggedInPlayer, userStats.math.bestStreak, 'math'); } showMathResult("¬°Correcto! üéâ", "correct"); playSound(correctSound, 'C5', '0.1s'); checkAndAwardMedal("math_first_correct"); if (userStats.math.questionsInLevel >= MATH_CORRECT_PER_LEVEL) { levelUpMath(); } else { setTimeout(nextMathProblem, 1000); } } else { userStats.math.playerLives--; userStats.math.correctStreak = 0; userStats.math.totalIncorrect++; showMathResult(`Incorrecto. La respuesta era ${mathCorrectAnswer}.`, "incorrect"); showMathExplanation(); playSound(incorrectSound, 'C3', '0.2s'); playSound(lifeLostSound, 'A2', '0.1s', '+0.1'); if (userStats.math.playerLives <= 0) { setTimeout(gameOverMath, 2000); } else { setTimeout(nextMathProblem, 2500); } } updateMathGameDisplay(); checkAndAwardAllMedals(); saveAllUsersData(); }
        function showMathExplanation() { /* ... */ const {num1, num2, operator} = mathCurrentProblemDetails; let explanation = `<strong>Explicaci√≥n:</strong> `; switch(operator) { case '+': explanation += `Sumar ${num1} y ${num2} da como resultado <code>${num1} + ${num2} = ${mathCorrectAnswer}</code>.`; break; case '-': explanation += `Restar ${num2} de ${num1} da como resultado <code>${num1} - ${num2} = ${mathCorrectAnswer}</code>.`; break; case '*': explanation += `Multiplicar ${num1} por ${num2} da como resultado <code>${num1} * ${num2} = ${mathCorrectAnswer}</code>.`; break; case '/': explanation += `Dividir ${num1} entre ${num2} da como resultado <code>${num1} / ${num2} = ${mathCorrectAnswer}</code>. (Porque ${num2} * ${mathCorrectAnswer} = ${num1}).`; break; } mathAnswerExplanationDisplay.innerHTML = explanation; mathAnswerExplanationDisplay.style.display = 'block'; }
        function levelUpMath() { /* ... */ const userStats = getUserStats(); userStats.math.currentLevel++; userStats.math.questionsInLevel = 0; userStats.math.correctStreak = 0; showMathResult(getCongratulationsMessage(), "level-up", 2500); playSound(levelUpSound, ['C4', 'E4', 'G4', 'C5'], '0.5s'); if (userStats.math.currentLevel > MATH_MAX_LEVEL) { showMathResult("¬°Has dominado Mates R√°pidas!", "correct", 3000); setTimeout(() => showScreen('selection'), 3000); return; } if (userStats.math.playerLives < INITIAL_LIVES) { userStats.math.playerLives++; showNotification("+1 Vida por subir de nivel!", "event", 1500); } setTimeout(nextMathProblem, 2500); checkAndAwardAllMedals(); }
        function levelDownMath() { /* ... */ const userStats = getUserStats(); if (userStats.math.currentLevel > 1) { userStats.math.currentLevel--; userStats.math.questionsInLevel = 0; userStats.math.correctStreak = 0; showMathResult("¬°Oh no! Has bajado al Nivel " + userStats.math.currentLevel, "level-down", 2000); playSound(levelDownSound, null, '0.3s'); } else { showMathResult("¬°Cuidado! Est√°s en el primer nivel.", "incorrect", 2000); } updateMathGameDisplay(); }
        function updateMathTimer() { /* ... */ const userStats = getUserStats(); mathTimeLeft--; mathTimeLeftDisplay.textContent = mathTimeLeft; if (mathTimeLeft <= 5 && mathTimeLeft > 0) { mathTimerWrapper.classList.add('text-red-500'); if (synthsInitialized && timerTickSound && mathTimeLeft % 2 === 0) playSound(timerTickSound, null, '32n'); } else { mathTimerWrapper.classList.remove('text-red-500'); } if (mathTimeLeft <= 0) { clearTimeout(mathTimerId); showMathResult("¬°Se acab√≥ el tiempo! ‚è∞", "incorrect"); userStats.math.playerLives--; userStats.math.correctStreak = 0; playSound(incorrectSound, 'A2', '0.3s'); playSound(lifeLostSound, 'G2', '0.1s', '+0.1'); if (userStats.math.playerLives <= 0) { setTimeout(gameOverMath, 2000); } else { setTimeout(nextMathProblem, 2000); } updateMathGameDisplay(); saveAllUsersData(); } }
        function updateMathGameDisplay() { /* ... */ const userStats = getUserStats(); if (!userStats) return; mathPlayerLivesDisplay.textContent = userStats.math.playerLives; mathCurrentLevelDisplay.textContent = userStats.math.currentLevel; mathCorrectStreakDisplay.textContent = userStats.math.correctStreak; mathCorrectPerLevelDisplay.textContent = MATH_CORRECT_PER_LEVEL; mathBestStreakDisplay.textContent = userStats.math.bestStreak; mathTimeLeftDisplay.textContent = mathTimeLeft; const progress = userStats.math.playerLives > 0 ? (userStats.math.questionsInLevel / MATH_CORRECT_PER_LEVEL) * 100 : 0; mathProgressBarFill.style.width = `${progress}%`; mathProgressBarFill.textContent = `${Math.round(progress)}%`; }
        function showMathResult(message, type, duration = 1500) { /* ... */ mathGameResultDisplay.textContent = message; mathGameResultDisplay.className = 'result ' + type; mathGameResultDisplay.style.animation = 'none'; mathGameResultDisplay.offsetHeight; mathGameResultDisplay.style.animation = null; if (type === "incorrect" || type === "level-down") { mathGameResultDisplay.classList.add('shake'); } }
        function getCongratulationsMessage() { /* ... */ const messageTemplate = congratulations[Math.floor(Math.random() * congratulations.length)]; return messageTemplate.replace("{name}", currentLoggedInPlayer).replace("{level}", getUserStats().math.currentLevel); }
        function gameOverMath() { /* ... */ const userStats = getUserStats(); clearTimeout(mathTimerId); showMathResult(`¬°Juego Terminado! Mejor racha: ${userStats.math.bestStreak}`, "incorrect", 3000); playSound(levelDownSound, null, '0.5s'); if (userStats.math.currentLevel > 1) levelDownMath(); if (userStats.math.bestStreak >= 3 && Math.random() < MATH_GAME_LOOT_BOX_PROBABILITY) { setTimeout(triggerLootBox, 1500); } setTimeout(() => { showScreen('selection'); userStats.math.correctStreak = 0; userStats.math.questionsInLevel = 0; }, 3000); saveAllUsersData(); }


        // --- Mind Twist Game V2 Logic (sin cambios significativos en su propia l√≥gica) ---
        function startMindTwistGameV2() { /* ... */ const userStats = getUserStats(); if (!userStats) return; playSound(gameStartSound, 'D4', '0.5s'); mindtwistV2DisplayPlayerName.textContent = currentLoggedInPlayer; mtV2_paused = false; mtV2PauseBtn.textContent = "Pausar"; userStats.mindtwistV2.currentLevel = userStats.mindtwistV2.highestLevelReached || 0; userStats.mindtwistV2.totalAttempts++; loadMindTwistV2Level(userStats.mindtwistV2.currentLevel); clearTimeout(mtV2_timerId); mtV2_timeLeft = MT_V2_BASE_TIME_PER_LEVEL; updateMindTwistV2TimerDisplay(); mtV2_timerId = setInterval(updateMindTwistV2TimerTick, 1000); checkAndAwardMedal("mindtwist_v2_first_try"); saveAllUsersData(); }
        function loadMindTwistV2Level(levelIndex) { /* ... */ const userStats = getUserStats(); const level = mindTwistV2Levels[levelIndex]; if (!level) { clearTimeout(mtV2_timerId); mtV2RiddleText.textContent = "¬°Felicidades! Has completado todos los acertijos."; mtV2OptionsContainer.innerHTML = ""; mtV2NextBtn.style.display = 'none'; mtV2HintBtn.style.display = 'none'; mtV2PauseBtn.style.display = 'none'; mtV2Feedback.textContent = `Total Resueltos: ${userStats.mindtwistV2.solvedCount}`; mtV2Feedback.className = "feedback-text correct"; playSound(levelUpSound, ['C5', 'E5', 'G5', 'C6'], '0.7s'); return; } mtV2LevelNumber.textContent = levelIndex + 1; mtV2RiddleText.textContent = level.riddle; mtV2Feedback.textContent = ""; mtV2Feedback.className = "feedback-text"; mtV2NextBtn.style.display = "none"; mtV2HintBtn.style.display = "inline-block"; mtV2PauseBtn.style.display = "inline-block"; mtV2OptionsContainer.innerHTML = ""; level.options.forEach((option, i) => { const btn = document.createElement("button"); btn.textContent = option; btn.className = "option-button"; btn.onclick = () => handleMindTwistV2Answer(i, level.answer); mtV2OptionsContainer.appendChild(btn); }); enableMindTwistV2Options();}
        function handleMindTwistV2Answer(selectedIndex, correctAnswerIndex) { /* ... */ if (mtV2_paused) return; const userStats = getUserStats(); if (selectedIndex === correctAnswerIndex) { playSound(mindTwistV2CorrectSound, 'E5', '0.1s'); mtV2Feedback.textContent = "¬°Correcto!"; mtV2Feedback.className = "feedback-text correct"; mtV2NextBtn.style.display = "inline-block"; disableMindTwistV2Options(); userStats.mindtwistV2.solvedCount++; if (userStats.mindtwistV2.currentLevel >= userStats.mindtwistV2.highestLevelReached) { userStats.mindtwistV2.highestLevelReached = userStats.mindtwistV2.currentLevel + 1; } checkAndAwardMedal("mindtwist_v2_solved_1"); mtV2_timeLeft += MT_V2_TIME_INCREMENT_CORRECT; updateMindTwistV2TimerDisplay(); if (Math.random() < MINDTWIST_V2_LOOT_BOX_PROBABILITY) { setTimeout(triggerLootBox, 500); } } else { playSound(mindTwistV2IncorrectSound, 'D3', '0.2s'); mtV2Feedback.textContent = "Intenta de nuevo."; mtV2Feedback.className = "feedback-text incorrect"; mtV2_timeLeft = Math.max(0, mtV2_timeLeft - 5); updateMindTwistV2TimerDisplay(); if (mtV2_timeLeft <=0) gameOverMindTwistV2(); } saveAllUsersData(); }
        function disableMindTwistV2Options() { /* ... */ Array.from(mtV2OptionsContainer.children).forEach(button => button.disabled = true); }
        function enableMindTwistV2Options() { /* ... */ Array.from(mtV2OptionsContainer.children).forEach(button => button.disabled = false); }
        mtV2HintBtn.onclick = () => { /* ... */ if (mtV2_paused) return; const userStats = getUserStats(); const level = mindTwistV2Levels[userStats.mindtwistV2.currentLevel]; if (level && level.hint) { mtV2Feedback.textContent = level.hint; mtV2Feedback.className = "feedback-text hint"; userStats.mindtwistV2.hintsUsed = (userStats.mindtwistV2.hintsUsed || 0) + 1; saveAllUsersData(); } };
        mtV2PauseBtn.onclick = () => { /* ... */ mtV2_paused = !mtV2_paused; mtV2PauseBtn.textContent = mtV2_paused ? "Reanudar" : "Pausar"; if (mtV2_paused) { clearTimeout(mtV2_timerId); mtV2Feedback.textContent = "Juego en pausa."; mtV2Feedback.className = "feedback-text paused"; disableMindTwistV2Options(); } else { mtV2Feedback.textContent = ""; mtV2Feedback.className = "feedback-text"; enableMindTwistV2Options(); if (mtV2_timeLeft > 0 && activeGame === 'mindtwist_v2') { mtV2_timerId = setInterval(updateMindTwistV2TimerTick, 1000); } } };
        mtV2NextBtn.onclick = () => { /* ... */ const userStats = getUserStats(); if (userStats.mindtwistV2.currentLevel < mindTwistV2Levels.length - 1) { userStats.mindtwistV2.currentLevel++; loadMindTwistV2Level(userStats.mindtwistV2.currentLevel); mtV2_timeLeft += 5; updateMindTwistV2TimerDisplay(); } else { loadMindTwistV2Level(userStats.mindtwistV2.currentLevel + 1); } saveAllUsersData(); };
        function updateMindTwistV2TimerDisplay() { /* ... */ mindtwistV2TimeLeftDisplay.textContent = mtV2_timeLeft; if (mtV2_timeLeft <= 5 && mtV2_timeLeft > 0) { mindtwistV2TimerWrapper.classList.add('text-red-500'); } else { mindtwistV2TimerWrapper.classList.remove('text-red-500'); } }
        function updateMindTwistV2TimerTick() { /* ... */ if (mtV2_paused) return; mtV2_timeLeft--; updateMindTwistV2TimerDisplay(); if (mtV2_timeLeft <= 5 && mtV2_timeLeft > 0) { if (synthsInitialized && timerTickSound && mtV2_timeLeft % 2 != 0) playSound(timerTickSound, null, '32n'); } if (mtV2_timeLeft <= 0) { gameOverMindTwistV2(); } }
        function gameOverMindTwistV2() { /* ... */ clearTimeout(mtV2_timerId); const userStats = getUserStats(); mtV2Feedback.textContent = "¬°Se acab√≥ el tiempo! ‚è∞"; mtV2Feedback.className = "feedback-text incorrect"; mtV2NextBtn.style.display = 'none'; disableMindTwistV2Options(); playSound(incorrectSound, 'A2', '0.3s'); if (userStats.mindtwistV2.solvedCount > 1 && Math.random() < MINDTWIST_V2_LOOT_BOX_PROBABILITY) { setTimeout(triggerLootBox, 500); } setTimeout(() => showScreen('selection'), 3000); saveAllUsersData(); }

        // --- Simon Game Logic (sin cambios) ---
        function startSimonGame() { /* ... */ const userStats = getUserStats(); if (!userStats) return; playSound(gameStartSound, 'E4', '0.5s'); simonGameActive = true; simonSequence = []; simonPlayerSequence = []; simonCurrentScore = 0; simonFeedbackDisplay.textContent = "Observa la secuencia..."; simonScoreDisplay.textContent = simonCurrentScore; simonStartButton.disabled = true; userStats.simon.totalGamesPlayed++; checkAndAwardMedal("first_game"); checkAndAwardMedal("simon_first_game"); saveAllUsersData(); setTimeout(simonNextComputerTurn, SIMON_ROUND_DELAY); }
        function simonNextComputerTurn() { /* ... */ if (!simonGameActive) return; simonTurn = 'computer'; simonPlayerSequence = []; simonFeedbackDisplay.textContent = "Observa..."; disableSimonPads(); const nextColor = SIMON_COLORS[Math.floor(Math.random() * SIMON_COLORS.length)]; simonSequence.push(nextColor); playSimonSequence(); }
        async function playSimonSequence() { /* ... */ await delay(SIMON_INTER_FLASH_DELAY / 2); for (const color of simonSequence) { if (!simonGameActive) return; await flashSimonPad(color, SIMON_FLASH_DURATION); await delay(SIMON_INTER_FLASH_DELAY); } if (simonGameActive) startPlayerTurnSimon(); }
        async function flashSimonPad(color, duration) { /* ... */ const padElement = simonPadElements[color]; padElement.classList.add('active'); playSound(simonPadSounds[color], getNoteForSimonColor(color), `${duration/1000}s`); await delay(duration); padElement.classList.remove('active'); }
        function getNoteForSimonColor(color) { /* ... */ switch(color) { case 'red': return 'C4'; case 'green': return 'E4'; case 'blue': return 'G4'; case 'yellow': return 'B4'; default: return 'C4'; } }
        function startPlayerTurnSimon() { /* ... */ simonTurn = 'player'; simonFeedbackDisplay.textContent = "¬°Tu turno!"; enableSimonPads(); }
        function handleSimonPadClick(event) { /* ... */ if (!simonGameActive || simonTurn !== 'player') return; const clickedColor = event.target.dataset.color; if (!clickedColor) return; flashSimonPad(clickedColor, 150); simonPlayerSequence.push(clickedColor); const currentStep = simonPlayerSequence.length - 1; if (simonPlayerSequence[currentStep] !== simonSequence[currentStep]) { gameOverSimon("¬°Incorrecto!"); return; } if (simonPlayerSequence.length === simonSequence.length) { simonCurrentScore += simonSequence.length; simonScoreDisplay.textContent = simonCurrentScore; playSound(correctSound, 'C5', '0.1s'); checkAndAwardMedal("simon_score_50"); if(simonSequence.length >= 5) checkAndAwardMedal("simon_sequence_5"); disableSimonPads(); simonFeedbackDisplay.textContent = "¬°Bien hecho!"; setTimeout(simonNextComputerTurn, SIMON_ROUND_DELAY); } }
        function gameOverSimon(message) { /* ... */ playSound(incorrectSound, 'C3', '0.3s'); simonFeedbackDisplay.textContent = `${message} Puntuaci√≥n final: ${simonCurrentScore}.`; simonGameActive = false; simonStartButton.disabled = false; disableSimonPads(); const userStats = getUserStats(); if (simonCurrentScore > userStats.simon.highestScore) { userStats.simon.highestScore = simonCurrentScore; showNotification(`¬°Nuevo r√©cord en Sim√≥n: ${simonCurrentScore} puntos!`, 'streak'); addToLeaderboard(currentLoggedInPlayer, simonCurrentScore, 'simon'); } if (simonSequence.length -1 > userStats.simon.longestSequence) { userStats.simon.longestSequence = Math.max(0, simonSequence.length -1) ; } saveAllUsersData(); updateSelectionScreenStats(); }
        function enableSimonPads() { /* ... */ Object.values(simonPadElements).forEach(pad => pad.disabled = false); }
        function disableSimonPads() { /* ... */ Object.values(simonPadElements).forEach(pad => pad.disabled = true); }
        function delay(ms) { /* ... */ return new Promise(resolve => setTimeout(resolve, ms)); }

        // --- Number Memory Game Logic (Clase y funciones de inicio) ---
        const NM_MAX_LEVEL = 20;
        class MemoryNumbersGame {
            constructor(userStatsRef, saveCallback, checkMedalCallback, addToLeaderboardCallback) {
                this.userStats = userStatsRef;
                this.saveDataCallback = saveCallback;
                this.checkMedalCallback = checkMedalCallback;
                this.addToLeaderboardCallback = addToLeaderboardCallback;

                this.sequence = [];
                this.playerSequence = [];
                this.level = 1;
                this.score = 0;
                this.gameActive = false;
                this.showingSequence = false;
                this.gridSize = 4;
                this.difficulty = this.userStats.numberMemory.currentDifficulty || 'medium';
                this.maxLevel = NM_MAX_LEVEL;

                this.bindEvents(); // Bind eventos una sola vez
                this.initializeGame(); // Configura el tablero inicial
            }

            initializeGame() {
                const cardCountConfig = { easy: 9, medium: 16, hard: 16, expert: 16 }; // 3x3 o 4x4
                const cardCount = cardCountConfig[this.difficulty] || 16;
                this.gridSize = Math.sqrt(cardCount);
                nmGameBoardElem.style.gridTemplateColumns = `repeat(${this.gridSize}, 1fr)`;
                this.createGameBoard();
                this.updateDisplay();
            }

            createGameBoard() {
                nmGameBoardElem.innerHTML = '';
                const totalNumbers = this.gridSize * this.gridSize;
                for (let i = 1; i <= totalNumbers; i++) {
                    const card = document.createElement('button');
                    card.className = 'nm-number-card hidden';
                    card.textContent = i;
                    card.dataset.number = i;
                    // El listener se a√±ade una vez, la l√≥gica de habilitar/deshabilitar controlar√° la interacci√≥n
                    card.addEventListener('click', () => this.handleCardClick(i));
                    nmGameBoardElem.appendChild(card);
                }
                this.disableCardClicks(); // Empezar con tarjetas deshabilitadas hasta que empiece el turno del jugador
            }

            bindEvents() {
                nmStartBtn.onclick = () => this.startGame();
                nmShowSequenceBtn.onclick = () => this.showSequenceVisual();
                nmResetBtn.onclick = () => this.resetGame();
                nmDifficultySelect.onchange = () => this.changeDifficulty();
            }

            changeDifficulty() {
                this.difficulty = nmDifficultySelect.value;
                this.userStats.numberMemory.currentDifficulty = this.difficulty;
                this.resetGame(); // Esto reiniciar√° el juego con la nueva dificultad
                this.saveDataCallback();
            }

            getSequenceLength() {
                const baseLengths = { easy: 3, medium: 4, hard: 5, expert: 6 };
                let length = baseLengths[this.difficulty];
                // Incrementar longitud cada 2 niveles, hasta un m√°ximo de (gridSize*gridSize - 2) o similar para que sea desafiante pero posible
                length += Math.floor((this.level -1) / 2);
                return Math.min(length, (this.gridSize * this.gridSize) -1 ); // No m√°s largo que el tablero
            }

            startGame() {
                playSound(gameStartSound, 'F4', '0.4s');
                this.userStats.numberMemory.gamesPlayed++;
                this.checkMedalCallback("nm_first_game");

                this.level = 1;
                this.score = 0;
                this.updateDisplay();
                this.gameActive = true;
                nmStartBtn.style.display = 'none';
                nmShowSequenceBtn.style.display = 'inline-block';
                this.nextLevel(); // Iniciar el primer nivel
            }

            nextLevel() {
                if (this.level > this.maxLevel) {
                    this.gameComplete();
                    return;
                }
                this.generateSequence();
                this.showSequenceVisual();
                this.showMessage(`Nivel ${this.level} - ¬°Memoriza la secuencia!`, 'info');
            }
             gameComplete() {
                this.gameActive = false;
                this.showMessage(`¬°Felicidades! Has completado todos los ${this.maxLevel} niveles. Puntuaci√≥n Final: ${this.score}`, 'success');
                nmStartBtn.style.display = 'inline-block';
                nmShowSequenceBtn.style.display = 'none';
                nmStartBtn.textContent = 'Jugar de Nuevo';
                this.disableCardClicks();
                this.saveDataCallback();
                updateSelectionScreenStats();
                if (this.score > 0 && Math.random() < NUMBER_MEMORY_LOOT_BOX_PROBABILITY) {
                    setTimeout(triggerLootBox, 500);
                }
            }


            generateSequence() {
                const sequenceLength = this.getSequenceLength();
                this.sequence = [];
                const maxNumber = this.gridSize * this.gridSize;
                for (let i = 0; i < sequenceLength; i++) {
                    this.sequence.push(Math.floor(Math.random() * maxNumber) + 1);
                }
                this.playerSequence = [];
            }

            async showSequenceVisual() { // Cambiado a async/await
                this.showingSequence = true;
                this.disableCardClicks();
                nmSequenceDisplayElem.textContent = `Secuencia: ${this.sequence.join(' ‚Üí ')}`;
                await this.wait(500); // Pausa antes de mostrar

                for (let i = 0; i < this.sequence.length; i++) {
                    if (!this.gameActive && !this.showingSequence) break; // Salir si el juego se detuvo
                    this.highlightCard(this.sequence[i]);
                    playSound(nmSequenceHighlightSound, 'C5', '0.1s');
                    await this.wait(800);
                    this.unhighlightCard(this.sequence[i]);
                    if (i < this.sequence.length - 1) await this.wait(300);
                }

                if (this.gameActive) { // Solo continuar si el juego no se detuvo
                    await this.wait(500);
                    nmSequenceDisplayElem.textContent = '';
                    this.showingSequence = false;
                    this.enableCardClicks();
                    this.showMessage('¬°Ahora repite la secuencia seleccionando las tarjetas!', 'info');
                }
            }
            hideAllCards() { const cards = nmGameBoardElem.querySelectorAll('.nm-number-card'); cards.forEach(card => card.classList.add('hidden'));}
            disableCardClicks() { Array.from(nmGameBoardElem.children).forEach(c => c.disabled = true); }
            enableCardClicks() { Array.from(nmGameBoardElem.children).forEach(c => c.disabled = false); }
            highlightCard(number) { const card = nmGameBoardElem.querySelector(`[data-number="${number}"]`); if (card) { card.classList.remove('hidden'); card.classList.add('pulse-effect');}}
            unhighlightCard(number) { const card = nmGameBoardElem.querySelector(`[data-number="${number}"]`); if (card) { card.classList.remove('pulse-effect'); card.classList.add('hidden');}}

            handleCardClick(number) {
                if (!this.gameActive || this.showingSequence) return;
                playSound(nmCardClickSound, 'A4', '0.05s');

                const card = nmGameBoardElem.querySelector(`[data-number="${number}"]`);
                if(card) {
                    card.classList.remove('hidden'); // Muestra el n√∫mero
                    card.classList.add('flipped'); // Estilo de "volteada"
                    setTimeout(() => { // Ocultar de nuevo despu√©s de un momento si no es parte de la secuencia final
                        if (!this.playerSequence.includes(parseInt(card.dataset.number)) || this.playerSequence.length !== this.sequence.length) {
                           // card.classList.add('hidden'); // Opcional: ocultar si no es el final
                           // card.classList.remove('flipped');
                        }
                    }, 600);
                }

                this.playerSequence.push(number);

                if (this.playerSequence[this.playerSequence.length - 1] !== this.sequence[this.playerSequence.length - 1]) {
                    playSound(nmErrorSound, 'C3', '0.2s');
                    this.gameOver();
                    return;
                }

                if (this.playerSequence.length === this.sequence.length) {
                    this.levelComplete();
                }
            }

            levelComplete() {
                playSound(correctSound, 'G5', '0.2s');
                this.score += this.level * (this.sequence.length * 2); // Puntuaci√≥n ajustada
                this.level++;
                if (this.level > this.userStats.numberMemory.highestLevelReached) {
                    this.userStats.numberMemory.highestLevelReached = this.level;
                }
                if (this.score > this.userStats.numberMemory.highestScore) {
                    this.userStats.numberMemory.highestScore = this.score;
                    this.addToLeaderboardCallback(currentLoggedInPlayer, this.score, 'numberMemory');
                }
                this.checkMedalCallback("nm_score_100");
                this.updateDisplay();
                this.showMessage(`¬°Nivel ${this.level - 1} completado!`, 'success');
                this.disableCardClicks();
                setTimeout(() => this.nextLevel(), 2000);
            }


            gameOver() {
                playSound(nmErrorSound || incorrectSound, 'D3', '0.3s'); // Usar sonido de error espec√≠fico o el gen√©rico
                this.gameActive = false;
                this.showMessage(`¬°Juego terminado! Puntuaci√≥n final: ${this.score}`, 'error');
                nmStartBtn.style.display = 'inline-block';
                nmShowSequenceBtn.style.display = 'none';
                nmStartBtn.textContent = 'Jugar de Nuevo';
                this.disableCardClicks();
                this.saveDataCallback();
                updateSelectionScreenStats();
                if (this.score > 50 && Math.random() < NUMBER_MEMORY_LOOT_BOX_PROBABILITY) { // Loot box si tuvo buen puntaje
                    setTimeout(triggerLootBox, 500);
                }
            }

            resetGame() {
                this.sequence = [];
                this.playerSequence = [];
                this.level = 1;
                this.score = 0;
                this.gameActive = false;
                this.showingSequence = false;
                this.difficulty = nmDifficultySelect.value;
                this.userStats.numberMemory.currentDifficulty = this.difficulty;

                this.initializeGame(); // Recrea el tablero con la dificultad actual
                nmStartBtn.style.display = 'inline-block';
                nmShowSequenceBtn.style.display = 'none';
                nmStartBtn.textContent = 'Comenzar';
                nmSequenceDisplayElem.textContent = '';
                this.hideMessage();
                this.updateDisplay(); // Asegura que la UI refleje el estado reseteado
                this.saveDataCallback();
            }
            pauseGameForScreenChange() {
                this.showingSequence = false; // Detener cualquier animaci√≥n de secuencia
                this.gameActive = false; // Marcar el juego como no activo para detener la l√≥gica interna
                 // No hay un temporizador continuo que necesite ser limpiado como en los otros juegos
                 // pero s√≠ hay que asegurarse que los botones se deshabiliten
                this.disableCardClicks();
                this.hideMessage(); // Limpiar mensajes
            }

            updateDisplay() {
                nmLevelDisplayElem.textContent = this.level;
                nmScoreDisplayElem.textContent = this.score;
                nmBestScoreDisplayElem.textContent = this.userStats.numberMemory.highestScore || 0;
                nmDifficultySelect.value = this.difficulty;
            }
            showMessage(text, type) { nmGameMessageElem.textContent = text; nmGameMessageElem.className = `nm-game-message nm-message-${type} show`; }
            hideMessage() { nmGameMessageElem.classList.remove('show'); }
            wait(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }
        }

        function startNumberMemoryGame() {
            playSound(gameStartSound, 'F4', '0.4s');
            const userStats = getUserStats();
            if (!userStats) return;
            if (!userStats.numberMemory) {
                userStats.numberMemory = defaultPlayerStats().numberMemory;
            }
            if (!nmGameInstance) {
                nmGameInstance = new MemoryNumbersGame(userStats, saveAllUsersData, checkAndAwardMedal, addToLeaderboard);
            } else {
                nmGameInstance.userStats = userStats; // Actualizar referencia por si cambi√≥ el usuario
            }
            nmGameInstance.difficulty = userStats.numberMemory.currentDifficulty || 'medium'; // Cargar dificultad guardada
            nmGameInstance.resetGame(); // Asegura que el juego est√° en un estado inicial limpio
            // El bot√≥n "Comenzar" dentro del juego iniciar√° la l√≥gica del primer nivel
            // Ya no es necesario simular el clic aqu√≠, el usuario lo har√°.
        }

        // --- Utility, Saving, Loading ---
        function triggerLootBox() { /* ... */ const userStats = getUserStats(); playSound(lootBoxSound, ['C4', 'E4', 'G4'], '0.4s'); lootBoxModal.classList.add('visible'); lootBoxRewardText.textContent = "Abriendo..."; setTimeout(() => { const rewards = ["+1 Vida Extra (Mates)", "Bonus de Racha (Mates)", "Bonus de Tiempo Inicial (Mates)"]; const randomReward = rewards[Math.floor(Math.random() * rewards.length)]; lootBoxRewardText.textContent = `¬°Has ganado: ${randomReward}!`; let notificationMsg = `¬°Recompensa obtenida: ${randomReward}!`; if (randomReward.includes("Vida Extra") && userStats.math.playerLives < INITIAL_LIVES + 2) { userStats.math.playerLives++; } else if (randomReward.includes("Racha")) { userStats.inventory.push("bonus_racha_mates"); notificationMsg = "¬°Bonus de Racha a√±adido a tu inventario!"; } else if (randomReward.includes("Tiempo Inicial")) { userStats.inventory.push("bonus_tiempo_inicio_mates"); notificationMsg = "¬°Bonus de Tiempo Inicial a√±adido!"; } showNotification(notificationMsg, "event", 2500); if (activeGame === 'math') updateMathGameDisplay(); saveAllUsersData(); }, 1500); }
        function closeLootBox() { /* ... */ playClickSound(); lootBoxModal.classList.remove('visible'); }
        function showNotification(message, type = 'success', duration = 3000) { /* ... */ notificationDisplay.textContent = message; notificationDisplay.className = 'notification show ' + type; setTimeout(() => { notificationDisplay.classList.remove('show'); }, duration); }

        const MAX_LEADERBOARD_ENTRIES = 5;
        let globalLeaderboard = { math: [], simon: [], numberMemory: [] };

        function updateLeaderboardDisplay() {
            leaderboardList.innerHTML = '';
            const mathLeaderboard = (globalLeaderboard.math || []).sort((a, b) => b.score - a.score).slice(0, MAX_LEADERBOARD_ENTRIES);
            const simonLeaderboard = (globalLeaderboard.simon || []).sort((a, b) => b.score - a.score).slice(0, MAX_LEADERBOARD_ENTRIES);
            const nmLeaderboard = (globalLeaderboard.numberMemory || []).sort((a, b) => b.score - a.score).slice(0, MAX_LEADERBOARD_ENTRIES);

            if (mathLeaderboard.length === 0 && simonLeaderboard.length === 0 && nmLeaderboard.length === 0) { leaderboardList.innerHTML = '<li class="leaderboard-item" style="text-align:center; color:#888;">A√∫n no hay puntajes.</li>'; return; }
            if(mathLeaderboard.length > 0) { const mathTitle = document.createElement('li'); mathTitle.innerHTML = `<strong>Mates (Mejor Racha)</strong>`; mathTitle.style.textAlign = 'center'; mathTitle.style.fontWeight = 'bold'; mathTitle.style.paddingBottom = '5px'; mathTitle.style.color = '#5A67D8'; leaderboardList.appendChild(mathTitle); mathLeaderboard.forEach(entry => { const li = document.createElement('li'); li.classList.add('leaderboard-item'); if (entry.name === currentLoggedInPlayer) { li.classList.add('you'); } li.innerHTML = `<span>${entry.name}</span> <strong>${entry.score}</strong>`; leaderboardList.appendChild(li); }); }
            if(simonLeaderboard.length > 0) { const simonTitle = document.createElement('li'); simonTitle.innerHTML = `<strong>Sim√≥n (Puntuaci√≥n M√°x.)</strong>`; simonTitle.style.textAlign = 'center'; simonTitle.style.fontWeight = 'bold'; simonTitle.style.paddingTop = '10px'; simonTitle.style.paddingBottom = '5px'; simonTitle.style.color = '#38A169'; leaderboardList.appendChild(simonTitle); simonLeaderboard.forEach(entry => { const li = document.createElement('li'); li.classList.add('leaderboard-item'); if (entry.name === currentLoggedInPlayer) { li.classList.add('you'); } li.innerHTML = `<span>${entry.name}</span> <strong>${entry.score}</strong>`; leaderboardList.appendChild(li); }); }
            if(nmLeaderboard.length > 0) { const nmTitle = document.createElement('li'); nmTitle.innerHTML = `<strong>Mem. N√∫meros (Puntuaci√≥n M√°x.)</strong>`; nmTitle.style.textAlign = 'center'; nmTitle.style.fontWeight = 'bold'; nmTitle.style.paddingTop = '10px'; nmTitle.style.paddingBottom = '5px'; nmTitle.style.color = '#805AD5'; leaderboardList.appendChild(nmTitle); nmLeaderboard.forEach(entry => { const li = document.createElement('li'); li.classList.add('leaderboard-item'); if (entry.name === currentLoggedInPlayer) { li.classList.add('you'); } li.innerHTML = `<span>${entry.name}</span> <strong>${entry.score}</strong>`; leaderboardList.appendChild(li); }); }
        }
        function addToLeaderboard(name, score, gameType) { if (!globalLeaderboard[gameType]) globalLeaderboard[gameType] = []; const board = globalLeaderboard[gameType]; const existingEntryIndex = board.findIndex(entry => entry.name === name); if (existingEntryIndex !== -1) { if (score > board[existingEntryIndex].score) { board[existingEntryIndex].score = score; } else { return; } } else { board.push({ name, score }); } board.sort((a, b) => b.score - a.score); if (board.length > MAX_LEADERBOARD_ENTRIES * 2) { globalLeaderboard[gameType] = board.slice(0, MAX_LEADERBOARD_ENTRIES * 2); } updateLeaderboardDisplay(); saveAllUsersData(); }

        function updateMedalsDisplay() { const userStats = getUserStats(); if (!userStats) return; medalsList.innerHTML = ''; MEDALS.forEach(medal => { const isUnlocked = userStats.medals.includes(medal.id); const medalDiv = document.createElement('div'); medalDiv.classList.add('medal-item'); medalDiv.textContent = medal.icon; const tooltipSpan = document.createElement('span'); tooltipSpan.classList.add('medal-tooltip'); tooltipSpan.textContent = `${medal.name}${isUnlocked ? '' : ' (Bloqueada)'} - ${medal.description}`; medalDiv.appendChild(tooltipSpan); if (!isUnlocked) { medalDiv.classList.add('locked'); } medalsList.appendChild(medalDiv); }); }
        function checkAndAwardMedal(medalId) { const userStats = getUserStats(); if (!userStats) return; const medal = MEDALS.find(m => m.id === medalId); if (medal && !userStats.medals.includes(medalId) && medal.condition(userStats)) { userStats.medals.push(medalId); showNotification(`¬°Medalla Desbloqueada: ${medal.name} ${medal.icon}!`, 'medal', 4000); playSound(medalSound, ['C5', 'G5', 'E5'], '0.4s'); updateMedalsDisplay(); saveAllUsersData(); } }
        function checkAndAwardAllMedals() { const userStats = getUserStats(); if(!userStats) return; MEDALS.forEach(medal => { if (!userStats.medals.includes(medal.id) && medal.condition(userStats)) { checkAndAwardMedal(medal.id); } }); }
        function checkDailyBonus() { const userStats = getUserStats(); if (!userStats) return; const today = new Date(); const todayDay = today.getDate(); const lastBonusDay = userStats.dailyBonusDay; if (!lastBonusDay || lastBonusDay !== todayDay) { dailyBonusCardContainer.style.display = 'block'; dailyBonusContainer.style.display = 'block'; const bonusOptions = ["+1 Vida (Mates)", "Bonus de Racha (Mates)", "Bonus de Tiempo Inicial (Mates)"]; const randomBonus = bonusOptions[Math.floor(Math.random() * bonusOptions.length)]; dailyBonusMessage.textContent = `¬°Tu recompensa de hoy es: ${randomBonus}!`; dailyBonusContainer.dataset.pendingBonus = randomBonus; } else { dailyBonusCardContainer.style.display = 'none'; dailyBonusContainer.style.display = 'none'; } }
        function collectDailyBonus() { playClickSound(); const userStats = getUserStats(); const pendingBonus = dailyBonusContainer.dataset.pendingBonus; if (pendingBonus) { let notificationMsg = `¬°Bonificaci√≥n reclamada: ${pendingBonus}!`; playSound(dailyBonusSound, ['D4', 'F#4', 'A4'], '0.5s'); if (pendingBonus.includes("Vida") && userStats.math.playerLives < INITIAL_LIVES + 2) { userStats.math.playerLives++; } else if (pendingBonus.includes("Racha")) { userStats.inventory.push("bonus_racha_mates"); notificationMsg = "¬°Bonus de Racha a√±adido a tu inventario!"; } else if (pendingBonus.includes("Tiempo Inicial")) { userStats.inventory.push("bonus_tiempo_inicio_mates"); notificationMsg = "¬°Bonus de Tiempo Inicial a√±adido!"; } showNotification(notificationMsg, 'event', 3000); userStats.dailyBonusDay = new Date().getDate(); dailyBonusCardContainer.style.display = 'none'; dailyBonusContainer.style.display = 'none'; delete dailyBonusContainer.dataset.pendingBonus; if (activeGame === 'math') updateMathGameDisplay(); saveAllUsersData(); } }

        const SAVE_KEY = 'mentalChallengesUserData_v7_numberMemory';
        function saveAllUsersData() { try { const dataToSave = { users: allUsersData, leaderboard: globalLeaderboard }; localStorage.setItem(SAVE_KEY, JSON.stringify(dataToSave)); } catch (e) { console.error("Error saving data:", e); showNotification("Error al guardar progreso.", "error", 5000); } }
        function loadAllUsersData() { try { const savedData = localStorage.getItem(SAVE_KEY); if (savedData) { const parsedData = JSON.parse(savedData); allUsersData = parsedData.users || {}; globalLeaderboard = parsedData.leaderboard || { math: [], simon: [], numberMemory: [] }; Object.values(allUsersData).forEach(userData => { if(!userData.stats) userData.stats = defaultPlayerStats(); // Parche por si faltan stats
            if (!userData.stats.mindtwistV2) { userData.stats.mindtwistV2 = defaultPlayerStats().mindtwistV2;} if (!userData.stats.numberMemory) { userData.stats.numberMemory = defaultPlayerStats().numberMemory;} });} else { allUsersData = {}; globalLeaderboard = { math: [], simon: [], numberMemory: [] }; } } catch (e) { console.error("Error loading data:", e); showNotification("Error al cargar datos guardados.", "error", 5000); allUsersData = {}; globalLeaderboard = { math: [], simon: [], numberMemory: [] }; } }

        mathUserAnswerInput.addEventListener('keypress', function(event) { if (event.key === 'Enter') { checkMathAnswer(); } });
        Object.values(simonPadElements).forEach(pad => {
            pad.addEventListener('click', handleSimonPadClick);
        });

        window.onload = () => {
            loadAllUsersData();
            updateLeaderboardDisplay();
            showScreen('welcome');
        };
    </script>
</body>
</html>
